<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Chemical Mixing ‚Äì Visible Droplets with Tilt</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 80%;
    }
    .drop-counter {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,100,255,0.8);
      color: white;
      padding: 10px;
      border-radius: 10px;
      z-index: 1000;
    }
  </style>

  <script>
    // Liquid levels
    let levelA = 0.3;
    let levelB = 0.05;
    let dropCount = 0;
    let activeDrops = [];

    const MIN = 0.05;
    const MAX = 0.3;
    const SPEED = 0.008;

    // State flags
    let tubeAVisible = false;
    let tubeBVisible = false;
    let reactionDone = false;
    let tiltThreshold = 30;
    let lastDropTime = 0;
    const dropInterval = 300;
    
    // Tilt tracking
    let currentPhoneTilt = 0;
    let currentTubeTilt = 0;
    let isPouring = false;
    let tiltAnimationId = null;

    // MARKER TRACKING
    AFRAME.registerComponent("marker-tracker", {
      schema: { id: { type: "string" } },

      init() {
        this.el.addEventListener("markerFound", () => {
          if (this.data.id === "A") {
            tubeAVisible = true;
            document.getElementById("marker-a-status").textContent = "‚úÖ Found";
          }
          if (this.data.id === "B") {
            tubeBVisible = true;
            document.getElementById("marker-b-status").textContent = "‚úÖ Found";
          }
          updateStatus();
        });

        this.el.addEventListener("markerLost", () => {
          if (this.data.id === "A") {
            tubeAVisible = false;
            document.getElementById("marker-a-status").textContent = "‚ùå Not found";
          }
          if (this.data.id === "B") {
            tubeBVisible = false;
            document.getElementById("marker-b-status").textContent = "‚ùå Not found";
          }
          updateStatus();
        });
      }
    });

    // TUBE TILTING SYSTEM - Makes test tube tilt when pouring
    AFRAME.registerComponent("tube-tilter", {
      schema: {
        tubeId: { type: "string" },
        maxTilt: { type: "number", default: 60 }
      },

      init: function () {
        console.log("Tube tilter initialized for tube:", this.data.tubeId);
        
        // Initial rotation
        this.el.setAttribute('rotation', '0 0 0');
        
        // Add reference for animation
        this.currentRotation = 0;
        this.targetRotation = 0;
        this.isAnimating = false;
      },

      tick: function () {
        // Smoothly animate to target rotation
        if (Math.abs(this.currentRotation - this.targetRotation) > 0.5) {
          this.currentRotation += (this.targetRotation - this.currentRotation) * 0.1;
          this.el.setAttribute('rotation', `${this.currentRotation} 0 0`);
          this.isAnimating = true;
        } else if (this.isAnimating) {
          this.el.setAttribute('rotation', `${this.targetRotation} 0 0`);
          this.currentRotation = this.targetRotation;
          this.isAnimating = false;
        }
      },

      tiltTube: function (tiltAngle) {
        // Map phone tilt to tube tilt (0¬∞ to maxTilt)
        const mappedTilt = Math.min(this.data.maxTilt, Math.max(0, tiltAngle - tiltThreshold));
        this.targetRotation = mappedTilt;
      },

      resetTilt: function () {
        this.targetRotation = 0;
      }
    });

    // DROPLET SYSTEM - Creates visible droplets
    AFRAME.registerComponent("drop-spawner", {
      init: function () {
        console.log("Drop spawner initialized");
        
        window.addEventListener("deviceorientation", (event) => {
          const tilt = event.beta || 0;
          currentPhoneTilt = tilt;
          const currentTime = Date.now();
          
          // Update tilt display
          document.getElementById("tilt-display").textContent = Math.round(tilt) + '¬∞';
          
          // Get tube A tilter component
          const tubeATilter = document.querySelector("#tubeA").components["tube-tilter"];
          
          // Spawn droplets when tilted and tube A is visible
          if (tilt > tiltThreshold && tubeAVisible && !reactionDone) {
            isPouring = true;
            
            // Tilt the tube based on phone tilt
            if (tubeATilter) {
              tubeATilter.tiltTube(tilt);
            }
            
            if (currentTime - lastDropTime > dropInterval) {
              lastDropTime = currentTime;
              this.spawnDrop();
              
              // Also update liquid levels
              updateLiquidLevels();
            }
          } else {
            isPouring = false;
            // Gradually return tube to upright position
            if (tubeATilter) {
              tubeATilter.resetTilt();
            }
          }
          
          // Check for reaction
          if (tilt > 40 && tubeAVisible && tubeBVisible && !reactionDone) {
            if (levelA <= MIN + 0.01) {
              triggerReaction();
            }
          }
        });
      },

      spawnDrop: function () {
        dropCount++;
        document.getElementById("drop-count").textContent = dropCount;
        
        // Create a visible droplet
        const drop = document.createElement("a-sphere");
        drop.setAttribute("radius", "0.03");
        drop.setAttribute("color", "#0088ff");
        drop.setAttribute("opacity", "0.9");
        
        // Position at the top of tube A's liquid
        // Get tube A's position and rotation
        const tubeA = document.querySelector("#tubeA");
        if (!tubeA) return;
        
        // Get current tube rotation
        const tubeRotation = tubeA.getAttribute('rotation') || {x: 0, y: 0, z: 0};
        const tiltRad = THREE.MathUtils.degToRad(tubeRotation.x);
        
        // Calculate drop position based on tube tilt
        const tiltOffset = 0.1 * Math.sin(tiltRad);
        drop.setAttribute("position", {
          x: tiltOffset,
          y: 0.28,
          z: 0
        });
        
        // Add initial velocity based on tilt
        drop.initialVelocity = {
          x: Math.sin(tiltRad) * 0.02,
          y: -0.01,
          z: 0
        };
        
        // Add glow effect for better visibility
        drop.setAttribute("light", {
          type: "point",
          color: "#0088ff",
          intensity: 0.3,
          distance: 0.5
        });
        
        // Add physics-like properties
        drop.velocity = { ...drop.initialVelocity };
        drop.gravity = 0.0005;
        
        // Add to tube A
        tubeA.appendChild(drop);
        
        // Store drop
        const dropId = 'drop-' + Date.now();
        drop.setAttribute('id', dropId);
        activeDrops.push({id: dropId, element: drop, velocity: drop.velocity});
        
        // Animate drop falling with physics
        this.animateDrop(drop, dropId);
      },

      animateDrop: function (drop, dropId) {
        let startY = 0.28;
        let currentY = startY;
        let currentX = 0;
        let currentZ = 0;
        const animationDuration = 1500;
        const startTime = Date.now();
        
        // Get initial velocity from drop object
        const velocity = drop.velocity || { x: 0, y: -0.01, z: 0 };
        const gravity = 0.0005;
        
        const animate = () => {
          const elapsed = Date.now() - startTime;
          
          if (elapsed < animationDuration && !reactionDone) {
            // Apply physics
            velocity.y -= gravity;
            currentX += velocity.x;
            currentY += velocity.y;
            currentZ += velocity.z;
            
            // Update drop position
            drop.setAttribute("position", {
              x: currentX,
              y: currentY,
              z: currentZ
            });
            
            // Slight wobble effect
            const wobble = Math.sin(elapsed * 0.01) * 0.005;
            drop.setAttribute("position", {
              x: currentX + wobble,
              y: currentY,
              z: currentZ + wobble * 0.5
            });
            
            // If drop falls below certain point, remove it
            if (currentY < -0.2) {
              if (drop.parentNode) {
                drop.parentNode.removeChild(drop);
              }
              const index = activeDrops.findIndex(d => d.id === dropId);
              if (index > -1) activeDrops.splice(index, 1);
              return;
            }
            
            requestAnimationFrame(animate);
          } else {
            // Remove drop
            if (drop.parentNode) {
              drop.parentNode.removeChild(drop);
            }
            // Remove from active drops
            const index = activeDrops.findIndex(d => d.id === dropId);
            if (index > -1) activeDrops.splice(index, 1);
          }
        };
        
        requestAnimationFrame(animate);
      }
    });

    // LIQUID SURFACE TILTING - Makes liquid surface tilt with tube
    AFRAME.registerComponent("liquid-tilter", {
      schema: {
        liquidId: { type: "string" },
        surfaceId: { type: "string" }
      },

      init: function () {
        this.liquidElement = document.querySelector(`#${this.data.liquidId}`);
        this.surfaceElement = document.querySelector(`#${this.data.surfaceId}`);
      },

      tick: function () {
        if (!this.liquidElement || !this.surfaceElement) return;
        
        // Get parent tube rotation
        const tube = this.el.parentNode || this.el;
        const tubeRotation = tube.getAttribute('rotation') || {x: 0, y: 0, z: 0};
        
        // Only tilt liquid surface when tube is tilted
        if (Math.abs(tubeRotation.x) > 5) {
          // Calculate liquid surface tilt (opposite direction to appear natural)
          const surfaceTilt = -tubeRotation.x * 0.7;
          
          // Update liquid surface rotation
          this.surfaceElement.setAttribute('rotation', `${-90 + surfaceTilt} 0 0`);
          
          // Adjust liquid surface position based on tilt
          const tiltRad = THREE.MathUtils.degToRad(tubeRotation.x);
          const offsetY = 0.02 * Math.sin(tiltRad);
          const currentPos = this.surfaceElement.getAttribute('position');
          this.surfaceElement.setAttribute('position', {
            x: currentPos.x,
            y: currentPos.y + offsetY,
            z: currentPos.z
          });
        } else {
          // Return to flat surface
          this.surfaceElement.setAttribute('rotation', '-90 0 0');
        }
      }
    });

    // Update liquid levels
    function updateLiquidLevels() {
      if (!tubeAVisible || !tubeBVisible || reactionDone) return;
      
      const liquidA = document.querySelector("#liquidA");
      const liquidB = document.querySelector("#liquidB");
      if (!liquidA || !liquidB) return;

      // Pour from A ‚Üí B
      if (levelA > MIN) {
        levelA -= SPEED * 0.5; // Slower since drops are separate
        levelB += SPEED * 0.5;
      }

      // Clamp values
      levelA = Math.max(MIN, levelA);
      levelB = Math.min(MAX, levelB);

      // Update Tube A
      liquidA.setAttribute("height", levelA);
      liquidA.setAttribute("position", `0 ${levelA / 2} 0`);

      // Update Tube B
      liquidB.setAttribute("height", levelB);
      liquidB.setAttribute("position", `0 ${levelB / 2} 0`);
      
      // Update liquid surfaces
      const surfaceA = document.querySelector("#surfaceA");
      const surfaceB = document.querySelector("#surfaceB");
      if (surfaceA) surfaceA.setAttribute('position', `0 ${levelA} 0`);
      if (surfaceB) surfaceB.setAttribute('position', `0 ${levelB} 0`);
    }

    // Trigger reaction
    function triggerReaction() {
      reactionDone = true;
      
      const liquidB = document.querySelector("#liquidB");
      if (liquidB) {
        liquidB.setAttribute("color", "#00ff00");
        
        // Also update the surface
        const surfaceB = document.querySelector("#surfaceB");
        if (surfaceB) surfaceB.setAttribute("color", "#00ff00");
        
        document.getElementById("reaction-status").textContent = "üéâ Reaction Complete!";
        document.getElementById("reaction-status").style.color = "#00ff00";
      }
      
      // Clear all drops
      clearAllDrops();
      
      // Make tube B wobble slightly to simulate reaction
      animateReactionWobble();
    }

    // Animate tube wobble during reaction
    function animateReactionWobble() {
      const tubeB = document.querySelector("#tubeB");
      if (!tubeB) return;
      
      const originalRotation = tubeB.getAttribute('rotation') || {x: 0, y: 0, z: 0};
      let wobbleTime = 0;
      
      function wobble() {
        if (wobbleTime < 2000) { // Wobble for 2 seconds
          wobbleTime += 16;
          const wobbleAngle = Math.sin(wobbleTime * 0.01) * 5;
          tubeB.setAttribute('rotation', {
            x: originalRotation.x + wobbleAngle,
            y: originalRotation.y,
            z: originalRotation.z
          });
          requestAnimationFrame(wobble);
        } else {
          // Return to original rotation
          tubeB.setAttribute('rotation', originalRotation);
        }
      }
      
      wobble();
    }

    // Clear all drops
    function clearAllDrops() {
      activeDrops.forEach(drop => {
        if (drop.element.parentNode) {
          drop.element.parentNode.removeChild(drop.element);
        }
      });
      activeDrops = [];
    }

    // Update status
    function updateStatus() {
      const status = document.getElementById("experiment-status");
      if (tubeAVisible && tubeBVisible) {
        status.textContent = "Ready! Tilt phone forward to pour";
      } else if (tubeAVisible) {
        status.textContent = "Tube A ready";
      } else if (tubeBVisible) {
        status.textContent = "Tube B ready";
      } else {
        status.textContent = "Show marker A or B";
      }
    }

    // Reset function
    window.resetExperiment = function() {
      reactionDone = false;
      dropCount = 0;
      levelA = 0.3;
      levelB = 0.05;
      isPouring = false;
      
      // Reset tube A rotation
      const tubeA = document.querySelector("#tubeA");
      if (tubeA) {
        tubeA.setAttribute('rotation', '0 0 0');
      }
      
      // Reset tube B rotation
      const tubeB = document.querySelector("#tubeB");
      if (tubeB) {
        tubeB.setAttribute('rotation', '0 0 0');
      }
      
      // Reset liquid A
      const liquidA = document.querySelector("#liquidA");
      if (liquidA) {
        liquidA.setAttribute("height", "0.3");
        liquidA.setAttribute("position", "0 0.15 0");
      }
      
      // Reset liquid B
      const liquidB = document.querySelector("#liquidB");
      if (liquidB) {
        liquidB.setAttribute("height", "0.05");
        liquidB.setAttribute("position", "0 0.025 0");
        liquidB.setAttribute("color", "yellow");
      }
      
      // Reset liquid surfaces
      const surfaceA = document.querySelector("#surfaceA");
      const surfaceB = document.querySelector("#surfaceB");
      if (surfaceA) {
        surfaceA.setAttribute("position", "0 0.3 0");
        surfaceA.setAttribute("rotation", "-90 0 0");
        surfaceA.setAttribute("color", "#0088ff");
      }
      if (surfaceB) {
        surfaceB.setAttribute("position", "0 0.05 0");
        surfaceB.setAttribute("rotation", "-90 0 0");
        surfaceB.setAttribute("color", "#ffff00");
      }
      
      // Clear drops
      clearAllDrops();
      
      // Update displays
      document.getElementById("drop-count").textContent = "0";
      document.getElementById("reaction-status").textContent = "Not reacted";
      document.getElementById("reaction-status").style.color = "white";
      document.getElementById("tilt-display").textContent = "0¬∞";
      
      updateStatus();
    };

  </script>

</head>

<body style="margin:0; overflow:hidden;">
  <!-- HUD Display -->
  <div id="hud">
    <h3 style="margin: 0 0 10px 0;">üß™ AR Chemical Experiment</h3>
    <p><strong>Status:</strong> <span id="experiment-status">Show marker A or B</span></p>
    <p><strong>Tilt:</strong> <span id="tilt-display">0¬∞</span></p>
    <p><strong>Pouring:</strong> <span id="pouring-status">No</span></p>
    <p><strong>Markers:</strong> 
      A: <span id="marker-a-status">‚ùå</span> | 
      B: <span id="marker-b-status">‚ùå</span>
    </p>
    <p><strong>Reaction:</strong> <span id="reaction-status">Not reacted</span></p>
    <button onclick="resetExperiment()" style="margin-top: 5px; padding: 5px 10px;">
      Reset Experiment
    </button>
  </div>
  
  <!-- Drop Counter -->
  <div class="drop-counter">
    üíß Drops: <span id="drop-count">0</span>
  </div>

  <a-scene
    embedded
    arjs="debugUIEnabled:false;"
    device-orientation-permission-ui="enabled: true">

    <!-- Lighting -->
    <a-light type="ambient" intensity="0.8"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.6"></a-light>

    <!-- ========== TEST TUBE A ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerA.patt"
      marker-tracker="id: A">

      <a-entity id="tubeA" drop-spawner tube-tilter="tubeId: A" position="0 0 0">
        <!-- Glass -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.25"
          roughness="0.1"
          metalness="0.5">
        </a-cylinder>

        <!-- Liquid A -->
        <a-cylinder
          id="liquidA"
          radius="0.13"
          height="0.3"
          position="0 0.15 0"
          color="#0088ff"
          opacity="0.9"
          roughness="0.2"
          metalness="0.1">
        </a-cylinder>

        <!-- Liquid surface for better visual -->
        <a-circle
          id="surfaceA"
          radius="0.13"
          position="0 0.3 0"
          color="#0088ff"
          opacity="0.9"
          rotation="-90 0 0">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- ========== TEST TUBE B ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerB.patt"
      marker-tracker="id: B">

      <a-entity id="tubeB" position="0 0 0">
        <!-- Glass -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.25"
          roughness="0.1"
          metalness="0.5">
        </a-cylinder>

        <!-- Liquid B -->
        <a-cylinder
          id="liquidB"
          radius="0.13"
          height="0.05"
          position="0 0.025 0"
          color="#ffff00"
          opacity="0.9"
          roughness="0.2"
          metalness="0.1">
        </a-cylinder>

        <!-- Liquid surface -->
        <a-circle
          id="surfaceB"
          radius="0.13"
          position="0 0.05 0"
          color="#ffff00"
          opacity="0.9"
          rotation="-90 0 0">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Instructions -->
  <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
              background: rgba(0,0,0,0.8); color: white; padding: 15px; 
              border-radius: 10px; text-align: center; max-width: 90%; z-index: 1000;">
    <h4 style="margin: 0 0 10px 0;">üìå INSTRUCTIONS:</h4>
    <p style="margin: 5px 0;">1. Show both markers (A and B)</p>
    <p style="margin: 5px 0;">2. <strong>Tilt phone FORWARD</strong> to pour</p>
    <p style="margin: 5px 0;">3. Watch blue droplets fall into yellow tube</p>
    <p style="margin: 5px 0;">4. <strong>Tube A will tilt</strong> as you pour</p>
    <p style="margin: 5px 0;">5. When all blue is poured, reaction happens!</p>
    <p style="margin: 5px 0; color: #ffcc00;">‚ö†Ô∏è Note: The test tube now tilts realistically when pouring!</p>
  </div>
  
  <script>
    // Update pouring status in real-time
    setInterval(() => {
      document.getElementById("pouring-status").textContent = isPouring ? "Yes" : "No";
      document.getElementById("pouring-status").style.color = isPouring ? "#00ff00" : "white";
    }, 100);
  </script>
</body>
</html>
