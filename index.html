<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Chemical Mixing ‚Äì Visible Liquids with Pouring</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 85%;
      border: 2px solid #0088ff;
    }
    .instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      max-width: 95%;
      z-index: 1000;
      border: 2px solid #ffff00;
    }
    .action-btn {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: #0088ff;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,136,255,0.4);
    }
    .pour-animation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: #0088ff;
      z-index: 1000;
      animation: pourFlow 2s ease-in-out;
      display: none;
    }
    @keyframes pourFlow {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -100%) scale(0.5); }
    }
  </style>

  <script>
    // State variables
    let tubeAVisible = false;
    let tubeBVisible = false;
    let isPouring = false;
    let reactionDone = false;
    let dropCount = 0;
    let activeDrops = [];
    
    // Liquid levels
    let blueLiquidLevel = 0.28;  // Visible height
    let yellowLiquidLevel = 0.10; // Visible height
    const BLUE_MAX = 0.28;
    const BLUE_MIN = 0.05;
    const YELLOW_MAX = 0.46; // Higher to accommodate mixed liquid
    
    // POURING SYSTEM
    AFRAME.registerComponent("pour-controller", {
      init: function () {
        console.log("Pour controller initialized");
        
        // Initialize liquid visibility
        this.setupLiquids();
        
        // Tilt detection for pouring
        window.addEventListener("deviceorientation", (event) => {
          const tilt = event.beta || 0;
          const gamma = event.gamma || 0; // Left-right tilt
          
          // Update tilt display
          document.getElementById("tilt-display").textContent = Math.round(tilt) + '¬∞';
          
          // Only start pouring if both tubes are visible
          if (tubeAVisible && tubeBVisible && !reactionDone) {
            // Detect pouring motion (phone tilted sideways and forward)
            if (Math.abs(gamma) > 45 && tilt > 20 && !isPouring) {
              this.startPouring();
            }
            
            // If pouring is active, continue based on tilt
            if (isPouring) {
              this.updatePouring(tilt, gamma);
            }
          }
        });
        
        // Touch/click to pour (alternative control)
        this.el.addEventListener("click", () => {
          if (tubeAVisible && tubeBVisible && !reactionDone && !isPouring) {
            this.startPouring();
          }
        });
      },
      
      setupLiquids: function() {
        // Ensure liquids are visible with proper positioning
        setTimeout(() => {
          const liquidA = document.querySelector("#liquidA");
          const liquidB = document.querySelector("#liquidB");
          const surfaceA = document.querySelector("#surfaceA");
          const surfaceB = document.querySelector("#surfaceB");
          
          if (liquidA) {
            liquidA.setAttribute("height", blueLiquidLevel);
            liquidA.setAttribute("position", `0 ${blueLiquidLevel/2} 0`);
            console.log("Liquid A setup:", liquidA.getAttribute("position"));
          }
          
          if (liquidB) {
            liquidB.setAttribute("height", yellowLiquidLevel);
            liquidB.setAttribute("position", `0 ${yellowLiquidLevel/2} 0`);
            console.log("Liquid B setup:", liquidB.getAttribute("position"));
          }
          
          if (surfaceA) {
            surfaceA.setAttribute("position", `0 ${blueLiquidLevel} 0`);
          }
          
          if (surfaceB) {
            surfaceB.setAttribute("position", `0 ${yellowLiquidLevel} 0`);
          }
        }, 1000);
      },
      
      startPouring: function () {
        console.log("Starting pour...");
        isPouring = true;
        
        // Show pour animation
        const pourAnim = document.getElementById("pour-animation");
        pourAnim.style.display = "block";
        pourAnim.textContent = "üíß";
        
        // Update status
        document.getElementById("pour-status").textContent = "POURING...";
        document.getElementById("pour-status").style.color = "#0088ff";
        
        // Hide after animation
        setTimeout(() => {
          pourAnim.style.display = "none";
        }, 2000);
      },
      
      updatePouring: function (tilt, gamma) {
        // Calculate pour intensity based on tilt
        const pourIntensity = Math.min((Math.abs(gamma) - 30) / 60, 1);
        
        if (pourIntensity > 0 && blueLiquidLevel > BLUE_MIN) {
          // Reduce blue liquid
          blueLiquidLevel -= 0.003 * pourIntensity;
          blueLiquidLevel = Math.max(BLUE_MIN, blueLiquidLevel);
          
          // Increase yellow liquid (with mixed color)
          yellowLiquidLevel += 0.003 * pourIntensity;
          yellowLiquidLevel = Math.min(YELLOW_MAX, yellowLiquidLevel);
          
          // Update tube A (blue) - VISIBLE LIQUID
          const liquidA = document.querySelector("#liquidA");
          const surfaceA = document.querySelector("#surfaceA");
          if (liquidA && surfaceA) {
            liquidA.setAttribute("height", blueLiquidLevel);
            liquidA.setAttribute("position", `0 ${blueLiquidLevel/2} 0`);
            surfaceA.setAttribute("position", `0 ${blueLiquidLevel} 0`);
            console.log("Liquid A updated - Height:", blueLiquidLevel, "Position:", blueLiquidLevel/2);
          }
          
          // Update tube B (yellow -> mixing) - VISIBLE LIQUID
          const liquidB = document.querySelector("#liquidB");
          const surfaceB = document.querySelector("#surfaceB");
          if (liquidB && surfaceB) {
            liquidB.setAttribute("height", yellowLiquidLevel);
            liquidB.setAttribute("position", `0 ${yellowLiquidLevel/2} 0`);
            surfaceB.setAttribute("position", `0 ${yellowLiquidLevel} 0`);
            
            // Calculate mixed color (blue + yellow = green)
            const mixRatio = (yellowLiquidLevel - 0.10) / (YELLOW_MAX - 0.10);
            const red = Math.floor(255 - mixRatio * 200);
            const green = Math.min(255, Math.floor(150 + mixRatio * 105));
            const blue = Math.floor(mixRatio * 100);
            const mixedColor = `rgb(${red}, ${green}, ${blue})`;
            
            liquidB.setAttribute("color", mixedColor);
            surfaceB.setAttribute("color", mixedColor);
            console.log("Liquid B updated - Height:", yellowLiquidLevel, "Color:", mixedColor);
          }
          
          // Create pouring droplets
          this.createPouringDroplets(pourIntensity);
          
          // Check if pouring is complete
          if (blueLiquidLevel <= BLUE_MIN + 0.01) {
            this.finishPouring();
          }
        }
      },
      
      createPouringDroplets: function (intensity) {
        // Create droplets based on pour intensity
        const dropletCount = Math.floor(intensity * 2);
        
        for (let i = 0; i < dropletCount; i++) {
          setTimeout(() => {
            this.createDroplet();
          }, i * 150);
        }
      },
      
      createDroplet: function () {
        dropCount++;
        document.getElementById("drop-count").textContent = dropCount;
        
        // Create droplet
        const drop = document.createElement("a-sphere");
        drop.setAttribute("radius", "0.025");
        drop.setAttribute("color", "#0088ff");
        drop.setAttribute("opacity", "0.9");
        
        // Position at tube A's pouring point
        const tubeA = document.querySelector("[marker-tracker='id: A']");
        if (!tubeA) return;
        
        // Starting position from top of blue liquid
        drop.setAttribute("position", {
          x: 0,
          y: blueLiquidLevel + 0.02, // Just above liquid surface
          z: 0
        });
        
        // Add to scene
        tubeA.appendChild(drop);
        
        // Store drop
        const dropId = 'drop-' + Date.now();
        drop.setAttribute('id', dropId);
        activeDrops.push({id: dropId, element: drop});
        
        // Animate droplet in an arc toward tube B
        this.animatePouringDroplet(drop, dropId);
      },
      
      animatePouringDroplet: function (drop, dropId) {
        const startTime = Date.now();
        const duration = 1000;
        
        const animate = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          if (progress < 1) {
            // Parabolic arc motion from Tube A to Tube B
            const x = Math.sin(progress * Math.PI) * 0.3; // Arc to the right
            const y = (blueLiquidLevel + 0.02) - (progress * 0.4); // Falling down
            const z = Math.cos(progress * Math.PI) * 0.1;
            
            drop.setAttribute("position", { x, y, z });
            
            requestAnimationFrame(animate);
          } else {
            // Remove drop
            if (drop.parentNode) {
              drop.parentNode.removeChild(drop);
            }
            const index = activeDrops.findIndex(d => d.id === dropId);
            if (index > -1) activeDrops.splice(index, 1);
          }
        };
        
        requestAnimationFrame(animate);
      },
      
      finishPouring: function () {
        console.log("Pouring complete!");
        isPouring = false;
        reactionDone = true;
        
        // Final mixed color (green)
        const liquidB = document.querySelector("#liquidB");
        const surfaceB = document.querySelector("#surfaceB");
        if (liquidB && surfaceB) {
          liquidB.setAttribute("color", "#00ff88");
          surfaceB.setAttribute("color", "#00ff88");
        }
        
        // Update status
        document.getElementById("pour-status").textContent = "REACTION COMPLETE!";
        document.getElementById("pour-status").style.color = "#00ff88";
        document.getElementById("experiment-status").innerHTML = 
          "<span style='color:#00ff88; font-size:18px;'>üéâ MIXING SUCCESSFUL! üéâ</span>";
        
        // Clear all droplets
        this.clearAllDrops();
        
        // Show celebration
        const pourAnim = document.getElementById("pour-animation");
        pourAnim.style.display = "block";
        pourAnim.textContent = "üéâ";
        pourAnim.style.color = "#00ff88";
        pourAnim.style.fontSize = "60px";
        
        setTimeout(() => {
          pourAnim.style.display = "none";
        }, 3000);
      },
      
      clearAllDrops: function () {
        activeDrops.forEach(drop => {
          if (drop.element.parentNode) {
            drop.element.parentNode.removeChild(drop.element);
          }
        });
        activeDrops = [];
      }
    });
    
    // MARKER TRACKING
    AFRAME.registerComponent("marker-tracker", {
      schema: { id: { type: "string" } },
      init() {
        this.el.addEventListener("markerFound", () => {
          console.log(`Marker ${this.data.id} found`);
          if (this.data.id === "A") {
            tubeAVisible = true;
            updateMarkerStatus("marker-a-status", "‚úÖ BLUE TUBE", "#0088ff");
            
            // Make sure liquid is visible
            setTimeout(() => {
              const liquidA = document.querySelector("#liquidA");
              if (liquidA) {
                liquidA.setAttribute("visible", "true");
                console.log("Liquid A should be visible");
              }
            }, 100);
          }
          if (this.data.id === "B") {
            tubeBVisible = true;
            updateMarkerStatus("marker-b-status", "‚úÖ YELLOW TUBE", "#ffff00");
            
            setTimeout(() => {
              const liquidB = document.querySelector("#liquidB");
              if (liquidB) {
                liquidB.setAttribute("visible", "true");
                console.log("Liquid B should be visible");
              }
            }, 100);
          }
          updateStatus();
        });
        
        this.el.addEventListener("markerLost", () => {
          if (this.data.id === "A") {
            tubeAVisible = false;
            updateMarkerStatus("marker-a-status", "‚ùå Not found", "#ff4444");
          }
          if (this.data.id === "B") {
            tubeBVisible = false;
            updateMarkerStatus("marker-b-status", "‚ùå Not found", "#ff4444");
          }
          updateStatus();
        });
      }
    });
    
    // HELPER FUNCTIONS
    function updateMarkerStatus(elementId, text, color) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = text;
        element.style.color = color;
        element.style.fontWeight = "bold";
      }
    }
    
    function updateStatus() {
      const status = document.getElementById("experiment-status");
      if (tubeAVisible && tubeBVisible) {
        status.innerHTML = "<span style='color:#00ff00'>‚úÖ READY! Tilt phone to pour</span>";
      } else if (tubeAVisible) {
        status.innerHTML = "<span style='color:#0088ff'>üîµ Blue tube ready</span>";
      } else if (tubeBVisible) {
        status.innerHTML = "<span style='color:#ffff00'>üü° Yellow tube ready</span>";
      } else {
        status.innerHTML = "<span style='color:#ff4444'>üëÜ Show both markers</span>";
      }
    }
    
    // MANUAL POUR BUTTON
    window.startManualPour = function() {
      if (tubeAVisible && tubeBVisible && !reactionDone) {
        const controller = document.querySelector("#tubeA").components["pour-controller"];
        if (controller) {
          controller.startPouring();
          
          let pourTime = 0;
          const pourInterval = setInterval(() => {
            if (pourTime < 3000 && blueLiquidLevel > BLUE_MIN) {
              controller.updatePouring(40, 60);
              pourTime += 100;
            } else {
              clearInterval(pourInterval);
              if (blueLiquidLevel <= BLUE_MIN + 0.01) {
                controller.finishPouring();
              }
            }
          }, 100);
        }
      }
    };
    
    // RESET FUNCTION
    window.resetExperiment = function() {
      console.log("Resetting experiment...");
      
      isPouring = false;
      reactionDone = false;
      dropCount = 0;
      blueLiquidLevel = 0.28;
      yellowLiquidLevel = 0.10;
      
      // Reset tube A (blue) - VISIBLE
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("height", "0.28");
        liquidA.setAttribute("position", "0 0.14 0");
        liquidA.setAttribute("color", "#0088ff");
        liquidA.setAttribute("visible", "true");
        surfaceA.setAttribute("position", "0 0.28 0");
        surfaceA.setAttribute("color", "#0088ff");
        surfaceA.setAttribute("visible", "true");
      }
      
      // Reset tube B (yellow) - VISIBLE
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("height", "0.10");
        liquidB.setAttribute("position", "0 0.05 0");
        liquidB.setAttribute("color", "#ffff00");
        liquidB.setAttribute("visible", "true");
        surfaceB.setAttribute("position", "0 0.10 0");
        surfaceB.setAttribute("color", "#ffff00");
        surfaceB.setAttribute("visible", "true");
      }
      
      // Clear drops
      const controller = document.querySelector("#tubeA")?.components["pour-controller"];
      if (controller) controller.clearAllDrops();
      
      // Update displays
      document.getElementById("drop-count").textContent = "0";
      document.getElementById("pour-status").textContent = "Ready to pour";
      document.getElementById("pour-status").style.color = "white";
      document.getElementById("tilt-display").textContent = "0¬∞";
      
      updateStatus();
    };

  </script>

</head>

<body style="margin:0; overflow:hidden;" onload="resetExperiment()">
  <!-- HUD Display -->
  <div id="hud">
    <h2 style="margin: 0 0 10px 0; color: #00aaff;">üß™ INTERACTIVE POURING EXPERIMENT</h2>
    <p><strong>Status:</strong> <span id="experiment-status">Show both markers</span></p>
    <p><strong>Tilt:</strong> <span id="tilt-display">0¬∞</span> | 
       <strong>Pour Status:</strong> <span id="pour-status">Ready to pour</span></p>
    <p><strong>Markers:</strong> 
      <span id="marker-a-status" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Blue Tube</span> 
      <span id="marker-b-status" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Yellow Tube</span>
    </p>
    <p><strong>üíß Droplets:</strong> <span id="drop-count">0</span></p>
    <button onclick="resetExperiment()" 
            style="margin-top: 10px; padding: 8px 15px; background: #ff4444; 
                   color: white; border: none; border-radius: 5px; font-weight: bold;
                   cursor: pointer; width: 100%;">
      üîÑ Reset Experiment
    </button>
  </div>
  
  <!-- Pour Animation -->
  <div id="pour-animation" class="pour-animation"></div>
  
  <!-- Manual Pour Button -->
  <button class="action-btn" onclick="startManualPour()">
    ü´ó POUR BLUE INTO YELLOW
  </button>

  <!-- AR Scene -->
  <a-scene 
    embedded 
    arjs="debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    device-orientation-permission-ui="enabled: true">
    
    <!-- Lights -->
    <a-light type="ambient" color="#ffffff" intensity="0.9"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.7"></a-light>
    <a-light type="point" position="0 1.5 0" intensity="0.4" color="#ffffff"></a-light>

    <!-- ========== TEST TUBE A (BLUE - To Pour From) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerA.patt"
      marker-tracker="id: A"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01">

      <a-entity id="tubeA" pour-controller position="0 0 0">
        <!-- Glass Tube (TRANSPARENT) -->
        <a-cylinder
          id="glassA"
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.15"
          roughness="0.1"
          metalness="0.8"
          transparent="true">
        </a-cylinder>

        <!-- Blue Liquid (VISIBLE) -->
        <a-cylinder
          id="liquidA"
          radius="0.13"
          height="0.28"
          position="0 0.14 0"
          color="#0088ff"
          opacity="0.9"
          roughness="0.2"
          metalness="0.1"
          visible="true">
        </a-cylinder>

        <!-- Liquid surface -->
        <a-circle
          id="surfaceA"
          radius="0.13"
          position="0 0.28 0"
          color="#0088ff"
          opacity="0.9"
          rotation="-90 0 0"
          visible="true">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- ========== TEST TUBE B (YELLOW - To Pour Into) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerB.patt"
      marker-tracker="id: B"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01">

      <a-entity position="0 0 0">
        <!-- Glass Tube (TRANSPARENT) -->
        <a-cylinder
          id="glassB"
          radius="0.15"
          height="0.7"
          position="0 0.35 0"
          color="#ffffff"
          opacity="0.15"
          roughness="0.1"
          metalness="0.8"
          transparent="true">
        </a-cylinder>

        <!-- Yellow Liquid (VISIBLE - will turn green) -->
        <a-cylinder
          id="liquidB"
          radius="0.13"
          height="0.10"
          position="0 0.05 0"
          color="#ffff00"
          opacity="0.9"
          roughness="0.2"
          metalness="0.1"
          visible="true">
        </a-cylinder>

        <!-- Liquid surface -->
        <a-circle
          id="surfaceB"
          radius="0.13"
          position="0 0.10 0"
          color="#ffff00"
          opacity="0.9"
          rotation="-90 0 0"
          visible="true">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Instructions -->
  <div class="instructions">
    <h3 style="margin: 0 0 10px 0;">üéØ HOW TO POUR:</h3>
    <p style="margin: 5px 0; color: #0088ff;">1. Show <strong>BLUE</strong> and <strong>YELLOW</strong> markers</p>
    <p style="margin: 5px 0; color: #ffff00;">2. <strong>TILT phone SIDEWAYS + FORWARD</strong> to pour</p>
    <p style="margin: 5px 0; color: #00ff88;">3. Watch droplets flow from blue to yellow tube</p>
    <p style="margin: 5px 0; color: #ffaa00;">4. See colors mix in real-time!</p>
    <p style="margin: 10px 0 0 0; font-size: 14px; color: #aaa;">
      Or click the <span style="color:#0088ff;">POUR</span> button above for manual control
    </p>
  </div>

</body>
</html>
