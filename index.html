<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Chemical Mixing ‚Äì Drag & Drop Pouring</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 85%;
      border: 2px solid #0088ff;
    }
    .action-btn {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: #0088ff;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,136,255,0.4);
    }
    .drag-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00ff00;
      font-size: 24px;
      z-index: 1000;
      display: none;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
  </style>

  <script>
    // STATE VARIABLES
    let tubeAVisible = false;
    let tubeBVisible = false;
    let isDragging = false;
    let isPouring = false;
    let reactionDone = false;
    
    // Liquid levels
    let blueLevel = 0.28;   // Full blue
    let yellowLevel = 0.10; // Starting yellow
    const BLUE_EMPTY = 0.05;
    const YELLOW_FULL = 0.46;
    
    // Dragging state
    let dragStartPos = { x: 0, y: 0 };
    let tubeAInitialPos = { x: 0, y: 0, z: 0 };
    
    // SIMPLE MARKER TRACKING
    AFRAME.registerComponent("simple-marker", {
      schema: { id: { type: "string" } },
      
      init() {
        this.el.addEventListener("markerFound", () => {
          console.log(`Marker ${this.data.id} FOUND`);
          
          if (this.data.id === "A") {
            tubeAVisible = true;
            document.getElementById("status-a").textContent = "‚úÖ BLUE TUBE";
            document.getElementById("status-a").style.color = "#0088ff";
            
            // Initialize blue tube position
            const tubeA = document.querySelector("#tubeA");
            if (tubeA) {
              const pos = tubeA.getAttribute("position");
              tubeAInitialPos = { x: pos.x, y: pos.y, z: pos.z };
            }
            
            // Make sure liquids are visible
            setTimeout(initializeLiquids, 100);
          }
          
          if (this.data.id === "B") {
            tubeBVisible = true;
            document.getElementById("status-b").textContent = "‚úÖ YELLOW TUBE";
            document.getElementById("status-b").style.color = "#ffff00";
            
            setTimeout(initializeLiquids, 100);
          }
          
          updateStatus();
        });
        
        this.el.addEventListener("markerLost", () => {
          if (this.data.id === "A") {
            tubeAVisible = false;
            document.getElementById("status-a").textContent = "‚ùå Not found";
            document.getElementById("status-a").style.color = "#ff4444";
          }
          
          if (this.data.id === "B") {
            tubeBVisible = false;
            document.getElementById("status-b").textContent = "‚ùå Not found";
            document.getElementById("status-b").style.color = "#ff4444";
          }
          
          updateStatus();
        });
      }
    });
    
    // DRAG & DROP COMPONENT
    AFRAME.registerComponent("drag-drop", {
      init() {
        console.log("Drag-drop component initialized");
        
        // Make the tube clickable
        this.el.classList.add("clickable");
        
        // Mouse/touch events
        this.el.addEventListener("mousedown", this.startDrag.bind(this));
        this.el.addEventListener("touchstart", this.startDrag.bind(this));
        
        // Store initial position
        this.initialPosition = this.el.getAttribute("position");
      },
      
      startDrag(event) {
        if (!tubeAVisible || !tubeBVisible || reactionDone) return;
        
        event.preventDefault();
        isDragging = true;
        
        // Get start position
        if (event.type === "touchstart") {
          dragStartPos = {
            x: event.touches[0].clientX,
            y: event.touches[0].clientY
          };
        } else {
          dragStartPos = {
            x: event.clientX,
            y: event.clientY
          };
        }
        
        // Store initial position
        this.initialPosition = this.el.getAttribute("position");
        
        // Show drag indicator
        document.getElementById("drag-indicator").style.display = "block";
        document.getElementById("drag-status").textContent = "‚úã DRAGGING BLUE TUBE...";
        document.getElementById("drag-status").style.color = "#00ff00";
        
        console.log("Started dragging blue tube");
        
        // Add move and end listeners
        document.addEventListener("mousemove", this.drag.bind(this));
        document.addEventListener("touchmove", this.drag.bind(this));
        document.addEventListener("mouseup", this.stopDrag.bind(this));
        document.addEventListener("touchend", this.stopDrag.bind(this));
      },
      
      drag(event) {
        if (!isDragging) return;
        
        event.preventDefault();
        
        // Get current mouse/touch position
        let currentX, currentY;
        
        if (event.type === "touchmove") {
          currentX = event.touches[0].clientX;
          currentY = event.touches[0].clientY;
        } else {
          currentX = event.clientX;
          currentY = event.clientY;
        }
        
        // Calculate movement
        const deltaX = (currentX - dragStartPos.x) * 0.002;
        const deltaY = (dragStartPos.y - currentY) * 0.002; // Inverted for natural feel
        
        // Update tube position
        const newPos = {
          x: this.initialPosition.x + deltaX,
          y: this.initialPosition.y + deltaY,
          z: this.initialPosition.z
        };
        
        this.el.setAttribute("position", newPos);
        
        // Check if blue tube is over yellow tube
        this.checkPouring(newPos);
      },
      
      checkPouring(blueTubePos) {
        if (!tubeBVisible || isPouring || reactionDone) return;
        
        const tubeB = document.querySelector("[simple-marker='id: B']");
        if (!tubeB) return;
        
        const yellowTubePos = tubeB.getAttribute("position");
        
        // Calculate distance between tubes
        const distance = Math.sqrt(
          Math.pow(blueTubePos.x - yellowTubePos.x, 2) +
          Math.pow(blueTubePos.y - yellowTubePos.y, 2)
        );
        
        // If tubes are close enough, start pouring
        if (distance < 0.25 && blueLevel > BLUE_EMPTY) {
          if (!isPouring) {
            startPouring();
          }
        } else if (isPouring) {
          stopPouring();
        }
        
        // Update distance display
        document.getElementById("distance-info").textContent = `Distance: ${distance.toFixed(2)}`;
      },
      
      stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        
        // Hide drag indicator
        document.getElementById("drag-indicator").style.display = "none";
        document.getElementById("drag-status").textContent = "üëÜ Drag blue tube over yellow tube";
        document.getElementById("drag-status").style.color = "white";
        
        // Stop pouring if was pouring
        if (isPouring) {
          stopPouring();
        }
        
        // Remove event listeners
        document.removeEventListener("mousemove", this.drag.bind(this));
        document.removeEventListener("touchmove", this.drag.bind(this));
        document.removeEventListener("mouseup", this.stopDrag.bind(this));
        document.removeEventListener("touchend", this.stopDrag.bind(this));
        
        console.log("Stopped dragging");
      }
    });
    
    // POURING SYSTEM
    function startPouring() {
      if (isPouring || reactionDone || blueLevel <= BLUE_EMPTY) return;
      
      console.log("Starting pouring...");
      isPouring = true;
      
      // Visual feedback
      document.getElementById("pour-status").textContent = "üíß POURING...";
      document.getElementById("pour-status").style.color = "#0088ff";
      
      // Start pouring animation
      pourAnimation();
    }
    
    function stopPouring() {
      if (!isPouring) return;
      
      console.log("Stopping pouring...");
      isPouring = false;
      
      document.getElementById("pour-status").textContent = "Ready to pour";
      document.getElementById("pour-status").style.color = "white";
    }
    
    function pourAnimation() {
      if (!isPouring || reactionDone) return;
      
      // Create a pouring droplet
      createDroplet();
      
      // Update liquid levels
      if (blueLevel > BLUE_EMPTY) {
        blueLevel -= 0.01;
        yellowLevel += 0.01;
        
        // Clamp values
        blueLevel = Math.max(BLUE_EMPTY, blueLevel);
        yellowLevel = Math.min(YELLOW_FULL, yellowLevel);
        
        // Update visuals
        updateLiquidVisuals();
        
        // Check if pouring complete
        if (blueLevel <= BLUE_EMPTY + 0.01) {
          completePouring();
          return;
        }
      }
      
      // Continue animation
      if (isPouring) {
        setTimeout(pourAnimation, 200);
      }
    }
    
    function createDroplet() {
      // Get tube positions
      const tubeA = document.querySelector("#tubeA");
      const tubeB = document.querySelector("[simple-marker='id: B']");
      
      if (!tubeA || !tubeB) return;
      
      const posA = tubeA.getAttribute("position");
      const posB = tubeB.getAttribute("position");
      
      // Create droplet
      const droplet = document.createElement("a-sphere");
      droplet.setAttribute("radius", "0.025");
      droplet.setAttribute("color", "#0088ff");
      droplet.setAttribute("opacity", "0.9");
      
      // Starting position (from blue tube)
      droplet.setAttribute("position", {
        x: posA.x,
        y: posA.y + 0.3,
        z: posA.z
      });
      
      // Add to scene
      document.querySelector("a-scene").appendChild(droplet);
      
      // Animate to yellow tube
      droplet.setAttribute("animation", {
        property: "position",
        to: `${posB.x} ${posB.y + 0.1} ${posB.z}`,
        dur: 800,
        easing: "easeInOutQuad"
      });
      
      droplet.setAttribute("animation__scale", {
        property: "scale",
        to: "0.5 0.5 0.5",
        dur: 800,
        easing: "easeInQuad"
      });
      
      // Remove after animation
      setTimeout(() => {
        if (droplet.parentNode) {
          droplet.parentNode.removeChild(droplet);
        }
      }, 850);
    }
    
    function completePouring() {
      isPouring = false;
      reactionDone = true;
      
      console.log("Pouring complete! Reaction finished.");
      
      // Make blue tube appear empty
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("opacity", "0.2");
        surfaceA.setAttribute("opacity", "0.2");
      }
      
      // Make yellow tube bright green
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("color", "#00ff00");
        surfaceB.setAttribute("color", "#00ff00");
      }
      
      // Update HUD
      document.getElementById("reaction-status").textContent = "üéâ REACTION COMPLETE!";
      document.getElementById("reaction-status").style.color = "#00ff00";
      document.getElementById("drag-status").textContent = "‚úÖ Mixing Successful!";
      document.getElementById("drag-status").style.color = "#00ff00";
      document.getElementById("status-a").textContent = "‚úÖ BLUE (EMPTY)";
    }
    
    // INITIALIZE LIQUIDS
    function initializeLiquids() {
      // Blue liquid
      let liquidA = document.querySelector("#liquidA");
      if (!liquidA) {
        liquidA = document.createElement("a-cylinder");
        liquidA.setAttribute("id", "liquidA");
        liquidA.setAttribute("radius", "0.13");
        liquidA.setAttribute("height", blueLevel);
        liquidA.setAttribute("position", `0 ${blueLevel/2} 0`);
        liquidA.setAttribute("color", "#0088ff");
        liquidA.setAttribute("opacity", "0.9");
        liquidA.setAttribute("visible", "true");
        
        const tubeA = document.querySelector("#tubeA");
        if (tubeA) tubeA.appendChild(liquidA);
      }
      
      // Blue surface
      let surfaceA = document.querySelector("#surfaceA");
      if (!surfaceA) {
        surfaceA = document.createElement("a-circle");
        surfaceA.setAttribute("id", "surfaceA");
        surfaceA.setAttribute("radius", "0.13");
        surfaceA.setAttribute("position", `0 ${blueLevel} 0`);
        surfaceA.setAttribute("color", "#0088ff");
        surfaceA.setAttribute("opacity", "0.9");
        surfaceA.setAttribute("rotation", "-90 0 0");
        surfaceA.setAttribute("visible", "true");
        
        const tubeA = document.querySelector("#tubeA");
        if (tubeA) tubeA.appendChild(surfaceA);
      }
      
      // Yellow liquid
      let liquidB = document.querySelector("#liquidB");
      if (!liquidB) {
        liquidB = document.createElement("a-cylinder");
        liquidB.setAttribute("id", "liquidB");
        liquidB.setAttribute("radius", "0.13");
        liquidB.setAttribute("height", yellowLevel);
        liquidB.setAttribute("position", `0 ${yellowLevel/2} 0`);
        liquidB.setAttribute("color", "#ffff00");
        liquidB.setAttribute("opacity", "0.9");
        liquidB.setAttribute("visible", "true");
        
        const tubeB = document.querySelector("#tubeB");
        if (tubeB) tubeB.appendChild(liquidB);
      }
      
      // Yellow surface
      let surfaceB = document.querySelector("#surfaceB");
      if (!surfaceB) {
        surfaceB = document.createElement("a-circle");
        surfaceB.setAttribute("id", "surfaceB");
        surfaceB.setAttribute("radius", "0.13");
        surfaceB.setAttribute("position", `0 ${yellowLevel} 0`);
        surfaceB.setAttribute("color", "#ffff00");
        surfaceB.setAttribute("opacity", "0.9");
        surfaceB.setAttribute("rotation", "-90 0 0");
        surfaceB.setAttribute("visible", "true");
        
        const tubeB = document.querySelector("#tubeB");
        if (tubeB) tubeB.appendChild(surfaceB);
      }
    }
    
    function updateLiquidVisuals() {
      // Update blue liquid
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("height", blueLevel);
        liquidA.setAttribute("position", `0 ${blueLevel/2} 0`);
        surfaceA.setAttribute("position", `0 ${blueLevel} 0`);
        
        // Fade as it empties
        const opacity = 0.2 + (blueLevel / 0.28) * 0.7;
        liquidA.setAttribute("opacity", opacity);
        surfaceA.setAttribute("opacity", opacity);
      }
      
      // Update yellow liquid
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("height", yellowLevel);
        liquidB.setAttribute("position", `0 ${yellowLevel/2} 0`);
        surfaceB.setAttribute("position", `0 ${yellowLevel} 0`);
        
        // Color mixing
        const mixRatio = (yellowLevel - 0.10) / (YELLOW_FULL - 0.10);
        let mixedColor;
        
        if (mixRatio < 0.3) {
          mixedColor = "#ffff00"; // Yellow
        } else if (mixRatio < 0.7) {
          mixedColor = "#aaff00"; // Yellow-Green
        } else {
          mixedColor = "#00ff00"; // Green
        }
        
        liquidB.setAttribute("color", mixedColor);
        surfaceB.setAttribute("color", mixedColor);
      }
    }
    
    // UPDATE STATUS
    function updateStatus() {
      const status = document.getElementById("experiment-status");
      if (tubeAVisible && tubeBVisible) {
        if (reactionDone) {
          status.innerHTML = "<span style='color:#00ff00'>üéâ MIXING COMPLETE!</span>";
        } else {
          status.innerHTML = "<span style='color:#00ff00'>‚úÖ READY TO DRAG & POUR!</span>";
        }
      } else if (tubeAVisible) {
        status.innerHTML = "<span style='color:#0088ff'>üîµ Blue tube found</span>";
      } else if (tubeBVisible) {
        status.innerHTML = "<span style='color:#ffff00'>üü° Yellow tube found</span>";
      } else {
        status.innerHTML = "<span style='color:#ff4444'>üëÜ Show markers</span>";
      }
    }
    
    // SIMULATE POURING (for testing)
    window.simulatePouring = function() {
      if (tubeAVisible && tubeBVisible && !reactionDone) {
        startPouring();
      } else {
        alert("Show both markers first!");
      }
    };
    
    // RESET FUNCTION
    window.resetExperiment = function() {
      reactionDone = false;
      isPouring = false;
      isDragging = false;
      blueLevel = 0.28;
      yellowLevel = 0.10;
      
      // Reset tube A position
      const tubeA = document.querySelector("#tubeA");
      if (tubeA) {
        tubeA.setAttribute("position", "0 0 0");
      }
      
      // Reset liquids
      updateLiquidVisuals();
      
      // Reset blue tube visibility
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("opacity", "0.9");
        surfaceA.setAttribute("opacity", "0.9");
      }
      
      // Reset yellow tube
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("color", "#ffff00");
        surfaceB.setAttribute("color", "#ffff00");
      }
      
      // Update HUD
      document.getElementById("reaction-status").textContent = "Not reacted";
      document.getElementById("reaction-status").style.color = "white";
      document.getElementById("drag-status").textContent = "üëÜ Drag blue tube over yellow tube";
      document.getElementById("drag-status").style.color = "white";
      document.getElementById("pour-status").textContent = "Ready to pour";
      document.getElementById("pour-status").style.color = "white";
      document.getElementById("distance-info").textContent = "Distance: --";
      document.getElementById("status-a").textContent = "‚úÖ BLUE TUBE";
      
      // Hide drag indicator
      document.getElementById("drag-indicator").style.display = "none";
      
      updateStatus();
    };
    
    // Initialize
    window.onload = function() {
      console.log("Page loaded. Waiting for markers...");
      updateStatus();
    };

  </script>

</head>

<body style="margin:0; overflow:hidden;">
  <!-- HUD Display -->
  <div id="hud">
    <h3 style="margin: 0 0 10px 0; color: #00aaff;">üß™ DRAG & DROP POURING</h3>
    <p><strong>Status:</strong> <span id="experiment-status">Show markers</span></p>
    <p><strong>Drag Status:</strong> <span id="drag-status">üëÜ Drag blue tube over yellow tube</span></p>
    <p><strong>Pour Status:</strong> <span id="pour-status">Ready to pour</span></p>
    <p><strong>Distance:</strong> <span id="distance-info">Distance: --</span></p>
    <p><strong>Markers:</strong><br>
      <span id="status-a" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Blue</span>
      <span id="status-b" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Yellow</span>
    </p>
    <p><strong>Reaction:</strong> <span id="reaction-status">Not reacted</span></p>
    <button onclick="resetExperiment()" 
            style="margin: 5px; padding: 8px 15px; background: #ff4444; 
                   color: white; border: none; border-radius: 5px; font-weight: bold;">
      üîÑ Reset
    </button>
  </div>
  
  <!-- Drag Indicator -->
  <div id="drag-indicator" class="drag-indicator">
    ‚úã DRAGGING
  </div>
  
  <!-- Action Button -->
  <button class="action-btn" onclick="simulatePouring()">
    ü´ó SIMULATE POURING
  </button>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="debugUIEnabled: false; sourceType: webcam;"
    renderer="antialias: true; alpha: true;"
    stats>

    <!-- Good lighting -->
    <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.8"></a-light>

    <!-- ========== TEST TUBE A (BLUE - DRAGGABLE) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerA.patt"
      simple-marker="id: A"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">

      <a-entity id="tubeA" drag-drop position="0 0 0">
        <!-- Glass (transparent) -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.15"
          transparent="true"
          roughness="0.1"
          metalness="0.3">
        </a-cylinder>

        <!-- Blue liquid will be added here -->

      </a-entity>

    </a-marker>

    <!-- ========== TEST TUBE B (YELLOW - TARGET) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerB.patt"
      simple-marker="id: B"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">

      <a-entity id="tubeB" position="0 0 0">
        <!-- Glass -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.15"
          transparent="true"
          roughness="0.1"
          metalness="0.3">
        </a-cylinder>

        <!-- Yellow liquid will be added here -->

      </a-entity>

    </a-marker>

    <!-- Camera -->
    <a-entity camera></a-entity>

  </a-scene>
  
  <!-- Instructions -->
  <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
              background: rgba(0,0,0,0.95); color: white; padding: 15px; 
              border-radius: 10px; text-align: center; max-width: 95%; z-index: 1000;
              border: 3px solid #00ff88;">
    <h4 style="margin: 0 0 10px 0;">üéØ HOW TO DRAG & POUR:</h4>
    <p style="margin: 5px 0; color: #0088ff;">1. Show <strong>BOTH</strong> markers (blue & yellow)</p>
    <p style="margin: 5px 0; color: #ffff00;">2. <strong>CLICK & HOLD</strong> the blue test tube</p>
    <p style="margin: 5px 0; color: #00ff88;">3. <strong>DRAG</strong> blue tube over yellow tube</p>
    <p style="margin: 5px 0; color: #ffaa00;">4. Watch <strong>AUTOMATIC POURING</strong> start!</p>
    <p style="margin: 10px 0 0 0; font-size: 12px; color: #aaa;">
      Or click <span style="color:#0088ff; font-weight:bold">SIMULATE POURING</span> for auto-demo
    </p>
  </div>
</body>
</html>
