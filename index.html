<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Chemical Mixing - Working Droplets</title>
  
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 1000;
      text-align: center;
      max-width: 90%;
    }
    #debug {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 14px;
    }
    .drop-counter {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 100, 255, 0.8);
      color: white;
      padding: 5px 15px;
      border-radius: 10px;
      z-index: 1000;
    }
  </style>

  <script>
    // Global variables
    let tubeAVisible = false;
    let tubeBVisible = false;
    let reactionDone = false;
    let tiltThreshold = 30; // Lower threshold for easier testing
    let lastDropTime = 0;
    const dropInterval = 500; // Slower drops for better visibility
    let dropCount = 0;
    let isTilting = false;
    
    // Store all active drops
    const activeDrops = [];
    
    // MARKER TRACKING
    AFRAME.registerComponent("marker-tracker", {
      schema: { id: { type: "string" } },
      init() {
        this.el.addEventListener("markerFound", () => {
          console.log(`Marker ${this.data.id} FOUND`);
          if (this.data.id === "A") {
            tubeAVisible = true;
            document.getElementById('markerA-status').textContent = "‚úÖ Found";
          }
          if (this.data.id === "B") {
            tubeBVisible = true;
            document.getElementById('markerB-status').textContent = "‚úÖ Found";
          }
          updateInfo();
        });
        
        this.el.addEventListener("markerLost", () => {
          console.log(`Marker ${this.data.id} LOST`);
          if (this.data.id === "A") {
            tubeAVisible = false;
            document.getElementById('markerA-status').textContent = "‚ùå Not found";
          }
          if (this.data.id === "B") {
            tubeBVisible = false;
            document.getElementById('markerB-status').textContent = "‚ùå Not found";
          }
          updateInfo();
        });
      }
    });
    
    // DROPLET SYSTEM - IMPROVED VISIBILITY
    AFRAME.registerComponent("drop-system", {
      init: function () {
        console.log("Drop system initialized!");
        
        // Tilt detection for drops
        if (window.DeviceOrientationEvent) {
          window.addEventListener("deviceorientation", (event) => {
            const tilt = Math.round(event.beta || 0); // Front-back tilt
            const currentTime = Date.now();
            
            // Update debug info
            document.getElementById('tilt-value').textContent = tilt + '¬∞';
            document.getElementById('tilt-status').textContent = 
              tilt > tiltThreshold ? "TILTING! Drops falling" : "Not tilting";
            
            // Check if we should spawn drops
            if (tilt > tiltThreshold && tubeAVisible && !reactionDone) {
              isTilting = true;
              
              // Spawn drops at intervals
              if (currentTime - lastDropTime > dropInterval) {
                lastDropTime = currentTime;
                this.spawnDrop();
              }
            } else {
              isTilting = false;
            }
            
            // Chemical reaction
            if (tilt > 40 && tubeAVisible && tubeBVisible && !reactionDone) {
              triggerReaction();
            }
          });
        } else {
          console.warn("Device orientation not supported");
          // Keyboard fallback
          document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
              this.spawnDrop();
            }
          });
        }
      },
      
      spawnDrop: function () {
        dropCount++;
        document.getElementById('drop-count').textContent = dropCount;
        
        // Create a visible drop
        const drop = document.createElement("a-sphere");
        const dropId = 'drop-' + Date.now();
        drop.setAttribute("id", dropId);
        drop.setAttribute("radius", "0.03"); // BIGGER for visibility
        drop.setAttribute("color", "#0088FF"); // Bright blue
        drop.setAttribute("opacity", "0.9");
        drop.setAttribute("shader", "flat");
        
        // Position drop at the TOP of test tube A's liquid
        // Test Tube A position is at marker origin
        drop.setAttribute("position", {
          x: 0,
          y: 0.28, // Top of liquid in tube A
          z: 0
        });
        
        // Add to scene - attach to tubeA entity
        const tubeA = document.querySelector("#tubeA");
        if (tubeA) {
          tubeA.appendChild(drop);
          
          // Store drop
          activeDrops.push({id: dropId, element: drop, startTime: Date.now()});
          
          // Animate the drop falling
          this.animateDrop(drop, dropId);
          
          console.log(`Drop spawned #${dropCount}`);
        }
      },
      
      animateDrop: function (drop, dropId) {
        let startY = 0.28;
        let currentY = startY;
        const fallSpeed = 0.01; // Slower fall
        const removeHeight = -0.3; // Fall further down
        
        const fallInterval = setInterval(() => {
          currentY -= fallSpeed;
          
          // Update drop position
          drop.setAttribute("position", {
            x: 0,
            y: currentY,
            z: 0
          });
          
          // Remove if fallen too far or reaction happened
          if (currentY < removeHeight || reactionDone) {
            clearInterval(fallInterval);
            if (drop.parentNode) {
              drop.parentNode.removeChild(drop);
            }
            // Remove from active drops
            const index = activeDrops.findIndex(d => d.id === dropId);
            if (index > -1) {
              activeDrops.splice(index, 1);
            }
          }
        }, 30); // 30ms interval for smooth animation
      }
    });
    
    // REACTION FUNCTION
    function triggerReaction() {
      console.log("CHEMICAL REACTION!");
      reactionDone = true;
      
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      
      if (liquidB && surfaceB) {
        // Change color to green
        liquidB.setAttribute("color", "#00FF00");
        surfaceB.setAttribute("color", "#00FF00");
        
        // Increase liquid level
        liquidB.setAttribute("height", "0.38");
        liquidB.setAttribute("position", "0 0.19 0");
        surfaceB.setAttribute("position", "0 0.38 0");
        
        // Update info
        document.getElementById('info').innerHTML = 
          "<h3>üéâ CHEMICAL REACTION! üéâ</h3>" +
          "<p>Blue + Yellow = Green</p>" +
          "<p>Reaction Complete!</p>";
        document.getElementById('info').style.background = "rgba(0, 255, 0, 0.8)";
        
        // Remove all active drops
        activeDrops.forEach(drop => {
          if (drop.element.parentNode) {
            drop.element.parentNode.removeChild(drop.element);
          }
        });
        activeDrops.length = 0;
      }
    }
    
    // Update info display
    function updateInfo() {
      const status = document.getElementById('status-text');
      if (tubeAVisible && tubeBVisible) {
        status.textContent = "Both tubes ready! Tilt phone forward.";
      } else if (tubeAVisible) {
        status.textContent = "Tube A ready. Show Tube B marker.";
      } else if (tubeBVisible) {
        status.textContent = "Tube B ready. Show Tube A marker.";
      } else {
        status.textContent = "Show marker A or B";
      }
    }
    
    // Reset function
    window.resetExperiment = function() {
      reactionDone = false;
      dropCount = 0;
      
      // Reset tube B
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("color", "yellow");
        liquidB.setAttribute("height", "0.10");
        liquidB.setAttribute("position", "0 0.05 0");
        surfaceB.setAttribute("color", "yellow");
        surfaceB.setAttribute("position", "0 0.10 0");
      }
      
      // Clear drops
      document.querySelectorAll('[id^="drop-"]').forEach(drop => {
        drop.parentNode.removeChild(drop);
      });
      
      // Update displays
      document.getElementById('drop-count').textContent = "0";
      document.getElementById('info').innerHTML = 
        "<h3>AR Chemical Experiment</h3>" +
        "<p>Tilt phone forward to drop blue liquid into yellow</p>";
      document.getElementById('info').style.background = "rgba(0, 0, 0, 0.8)";
      
      console.log("Experiment reset");
    };
    
  </script>
</head>

<body>
  <!-- Top Info -->
  <div id="info">
    <h3>AR Chemical Experiment</h3>
    <p>Tilt phone forward to drop blue liquid into yellow</p>
  </div>
  
  <!-- Drop Counter -->
  <div class="drop-counter">
    üíß Drops: <span id="drop-count">0</span>
  </div>
  
  <!-- Debug Panel -->
  <div id="debug">
    <p><strong>Status:</strong> <span id="status-text">Show marker A or B</span></p>
    <p><strong>Tilt:</strong> <span id="tilt-value">0¬∞</span> | 
       <span id="tilt-status">Not tilting</span></p>
    <p><strong>Markers:</strong> 
      <span id="markerA-status">‚ùå Not found</span> | 
      <span id="markerB-status">‚ùå Not found</span>
    </p>
    <button onclick="resetExperiment()" style="margin-top:5px; padding:5px 10px;">
      Reset Experiment
    </button>
  </div>

  <!-- AR SCENE -->
  <a-scene 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false;"
    device-orientation-permission-ui="enabled: true">
    
    <!-- Lights -->
    <a-light type="ambient" color="#FFFFFF" intensity="0.8"></a-light>
    <a-light type="directional" position="1 1 1" intensity="0.5"></a-light>
    
    <!-- TEST TUBE A (Blue - with drop system) -->
    <a-marker 
      type="pattern" 
      url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt"
      marker-tracker="id: A"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">
      
      <a-entity id="tubeA" drop-system position="0 0 0">
        <!-- Glass Tube -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#FFFFFF"
          opacity="0.2"
          roughness="0.1"
          metalness="0.8">
        </a-cylinder>
        
        <!-- BLUE LIQUID (Stable) -->
        <a-cylinder
          id="liquidA"
          radius="0.13"
          height="0.28"
          position="0 0.14 0"
          color="#0088FF"
          opacity="0.85"
          roughness="0.3">
        </a-cylinder>
        
        <!-- Liquid Surface -->
        <a-circle
          id="surfaceA"
          radius="0.13"
          position="0 0.28 0"
          color="#0088FF"
          opacity="0.9"
          rotation="-90 0 0">
        </a-circle>
        
      </a-entity>
    </a-marker>
    
    <!-- TEST TUBE B (Yellow) -->
    <a-marker 
      type="pattern" 
      url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.patt"
      marker-tracker="id: B"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">
      
      <a-entity position="0 0 0">
        <!-- Glass Tube -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#FFFFFF"
          opacity="0.2"
          roughness="0.1"
          metalness="0.8">
        </a-cylinder>
        
        <!-- YELLOW LIQUID (Stable) -->
        <a-cylinder
          id="liquidB"
          radius="0.13"
          height="0.10"
          position="0 0.05 0"
          color="#FFFF00"
          opacity="0.85"
          roughness="0.3">
        </a-cylinder>
        
        <!-- Liquid Surface -->
        <a-circle
          id="surfaceB"
          radius="0.13"
          position="0 0.10 0"
          color="#FFFF00"
          opacity="0.9"
          rotation="-90 0 0">
        </a-circle>
        
      </a-entity>
    </a-marker>
    
    <!-- Camera -->
    <a-entity camera></a-entity>
    
  </a-scene>
  
  <!-- Instructions Overlay -->
  <div style="position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); 
              background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px;
              text-align: center; max-width: 90%; z-index: 1000;">
    <h4 style="margin: 0 0 10px 0;">üìå HOW TO USE:</h4>
    <p style="margin: 5px 0;">1. Show HIRO marker for BLUE test tube</p>
    <p style="margin: 5px 0;">2. Show KANJI marker for YELLOW test tube</p>
    <p style="margin: 5px 0;">3. <strong>Tilt phone FORWARD</strong> to drop blue liquid</p>
    <p style="margin: 5px 0;">4. Tilt more than 40¬∞ for reaction</p>
    
    <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
      <p>Markers: <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank">HIRO</a> | 
         <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.png" target="_blank">KANJI</a></p>
    </div>
  </div>
  
  <script>
    // Auto-start instructions
    setTimeout(() => {
      if (!tubeAVisible && !tubeBVisible) {
        document.getElementById('info').innerHTML += 
          '<p style="color:#FF9900; margin-top:5px;">Show HIRO or KANJI marker to begin</p>';
      }
    }, 3000);
  </script>
</body>
</html>
