<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Chemical Mixing - Realistic Pouring</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

<style>
body{margin:0;overflow:hidden;font-family:Arial;}
#hud{
position:absolute;
top:10px;
left:10px;
background:rgba(0,0,0,0.8);
color:white;
padding:10px;
border-radius:10px;
z-index:1000;
}
button{
background:#4CAF50;
color:white;
border:none;
padding:8px 16px;
border-radius:5px;
cursor:pointer;
}
.position-info{
position:absolute;
top:10px;
right:10px;
background:rgba(0,0,0,0.7);
color:white;
padding:5px 10px;
border-radius:5px;
font-size:12px;
z-index:1000;
}
.instruction{
position:absolute;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:rgba(0,100,200,0.9);
color:white;
padding:10px 20px;
border-radius:10px;
text-align:center;
max-width:80%;
z-index:1000;
}
</style>

<script>
let tubeAVisible=false;
let tubeBVisible=false;
let isDragging=false;
let reactionStarted=false;
let tubeAElement=null;
let tubeBElement=null;
let markerARotation=0;
let markerBRotation=0;

let dragStartScreenX=0;
let dragStartScreenY=0;
let tubeStartPos={x:0,y:0,z:0};

const BLUE_COLOR='#0066cc';
const YELLOW_COLOR='#ffcc00';
const GREEN_COLOR='#00cc66';
const MIXING_COLOR='#339933';

let liquidLevelA=0.45;
let liquidLevelB=0.45;
let pourAngle=0;
let isPouringActive=false;
let pourInterval=null;
let pouredAmount=0;
const MAX_POUR=0.35;

document.addEventListener('DOMContentLoaded',function(){
const scene=document.querySelector('a-scene');

scene.addEventListener('markerFound',function(e){
if(e.target.id==='markerA'){
tubeAVisible=true;
tubeAElement=document.querySelector('#tubeA');
document.getElementById('status').textContent="Blue tube found";
updateLiquidLevels();
}
if(e.target.id==='markerB'){
tubeBVisible=true;
tubeBElement=document.querySelector('#tubeB');
document.getElementById('status').textContent="Yellow tube found";
}
if(tubeAVisible && tubeBVisible){
document.getElementById('status').textContent="Ready - Drag blue tube to pour";
updatePositionInfo();
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt and pour liquid");
}
});

scene.addEventListener('markerLost',function(e){
if(e.target.id==='markerA'){
tubeAVisible=false;
}
if(e.target.id==='markerB'){
tubeBVisible=false;
}
updateStatus();
});

// Track marker rotation
scene.addEventListener('markerPoseFound', function(e) {
  const marker = e.target;
  if (marker.id === 'markerA' && marker.object3D) {
    const rotation = marker.object3D.rotation;
    markerARotation = rotation.y * (180 / Math.PI);
    if (tubeAElement && !isPouringActive) {
      tubeAElement.setAttribute('rotation', `0 ${markerARotation} 0`);
    }
  }
  if (marker.id === 'markerB' && marker.object3D) {
    const rotation = marker.object3D.rotation;
    markerBRotation = rotation.y * (180 / Math.PI);
    if (tubeBElement) {
      tubeBElement.setAttribute('rotation', `0 ${markerBRotation} 0`);
    }
  }
});

// Mouse events for laptop/desktop
scene.addEventListener('mousedown',function(e){
if(reactionStarted || !tubeAVisible || !tubeBVisible) return;
e.preventDefault();
e.stopPropagation();
dragStartScreenX=e.clientX;
dragStartScreenY=e.clientY;
if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}
isDragging=true;
document.getElementById('status').textContent="Dragging...";
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt the tube");
});

scene.addEventListener('mousemove',function(e){
if(!isDragging || !tubeAElement || reactionStarted) return;
e.preventDefault();
e.stopPropagation();
const currentScreenX=e.clientX;
const currentScreenY=e.clientY;
const deltaScreenX=currentScreenX-dragStartScreenX;
const deltaScreenY=currentScreenY-dragStartScreenY;
const speedFactor=0.005;
const deltaX=deltaScreenX*speedFactor;
const deltaZ=deltaScreenY*speedFactor;
const newX=tubeStartPos.x+deltaX;
const newZ=tubeStartPos.z+deltaZ;
tubeAElement.object3D.position.x=newX;
tubeAElement.object3D.position.z=newZ;

// ALWAYS calculate tilt based on vertical drag - removed distance requirement
pourAngle = Math.max(0, Math.min(-75, -deltaScreenY * 0.3));
tubeAElement.setAttribute('rotation', `${pourAngle} ${markerARotation} 0`);

// Pouring is active if tilted enough, regardless of distance
isPouringActive = pourAngle < -15;

updatePositionInfo();
checkDistanceForReaction();

// If pouring is active, create pouring effect
if(isPouringActive && !reactionStarted){
startPouring();
}else{
stopPouring();
}
});

scene.addEventListener('mouseup',function(e){
if(!isDragging) return;
isDragging=false;
isPouringActive=false;
stopPouring();

if(tubeAElement){
tubeAElement.setAttribute('rotation', `0 ${markerARotation} 0`);
}

if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}

document.getElementById('status').textContent="Ready - Drag blue tube";
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt and pour liquid");
});

// Touch events for mobile
scene.addEventListener('touchstart',function(e){
if(reactionStarted || !tubeAVisible || !tubeBVisible) return;
e.preventDefault();
e.stopPropagation();
const touch=e.touches[0];
dragStartScreenX=touch.clientX;
dragStartScreenY=touch.clientY;
if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}
isDragging=true;
document.getElementById('status').textContent="Dragging...";
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt the tube");
});

scene.addEventListener('touchmove',function(e){
if(!isDragging || !tubeAElement || reactionStarted) return;
e.preventDefault();
e.stopPropagation();
const touch=e.touches[0];
const currentScreenX=touch.clientX;
const currentScreenY=touch.clientY;
const deltaScreenX=currentScreenX-dragStartScreenX;
const deltaScreenY=currentScreenY-dragStartScreenY;
const speedFactor=0.005;
const deltaX=deltaScreenX*speedFactor;
const deltaZ=deltaScreenY*speedFactor;
const newX=tubeStartPos.x+deltaX;
const newZ=tubeStartPos.z+deltaZ;
tubeAElement.object3D.position.x=newX;
tubeAElement.object3D.position.z=newZ;

// ALWAYS calculate tilt based on vertical drag - removed distance requirement
pourAngle = Math.max(0, Math.min(-75, -deltaScreenY * 0.3));
tubeAElement.setAttribute('rotation', `${pourAngle} ${markerARotation} 0`);

// Pouring is active if tilted enough, regardless of distance
isPouringActive = pourAngle < -15;

updatePositionInfo();
checkDistanceForReaction();

// If pouring is active, create pouring effect
if(isPouringActive && !reactionStarted){
startPouring();
}else{
stopPouring();
}
});

scene.addEventListener('touchend',function(e){
if(!isDragging) return;
isDragging=false;
isPouringActive=false;
stopPouring();

if(tubeAElement){
tubeAElement.setAttribute('rotation', `0 ${markerARotation} 0`);
}

if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}

document.getElementById('status').textContent="Ready - Drag blue tube";
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt and pour liquid");
});

// Prevent default click behavior
scene.addEventListener('click',function(e){
e.preventDefault();
e.stopPropagation();
return false;
});
});

function startPouring(){
if(pourInterval) return;
pourInterval = setInterval(() => {
if(pouredAmount < MAX_POUR && !reactionStarted){
const pourRate = Math.abs(pourAngle) / 90 * 0.01;
liquidLevelA = Math.max(0.1, liquidLevelA - pourRate);
liquidLevelB = Math.min(0.6, liquidLevelB + pourRate);
pouredAmount += pourRate;
updateLiquidLevels();
createPouringDroplet();
createPouringDroplet();
}
}, 30);
}

function stopPouring(){
if(pourInterval){
clearInterval(pourInterval);
pourInterval = null;
}
}

function createPouringDroplet(){
if(!tubeAElement || !tubeBElement) return;

// Create multiple droplets with slight variations
for(let i=0; i<2; i++){
const drop=document.createElement('a-sphere');
drop.setAttribute('radius',0.012 + Math.random()*0.008);
drop.setAttribute('color',BLUE_COLOR);
drop.setAttribute('opacity',0.9);
drop.setAttribute('metalness',0.3);
drop.setAttribute('roughness',0.2);

// Calculate drop start position from tilted tube opening
const tiltRad = pourAngle * Math.PI / 180;
const startX = tubeAElement.object3D.position.x + (Math.random() - 0.5) * 0.05;
const startY = tubeAElement.object3D.position.y + 0.3 - Math.sin(tiltRad) * 0.35 + (Math.random() * 0.05);
const startZ = tubeAElement.object3D.position.z + Math.cos(tiltRad) * 0.35 + (Math.random() - 0.5) * 0.05;

drop.setAttribute('position',{
x:startX,
y:startY,
z:startZ
});

// Target position (yellow tube opening)
const targetX = tubeBElement.object3D.position.x + (Math.random() - 0.5) * 0.08;
const targetY = tubeBElement.object3D.position.y + 0.4 + (Math.random() * 0.1);
const targetZ = tubeBElement.object3D.position.z + (Math.random() - 0.5) * 0.08;

// Parabolic arc animation for realistic pour
drop.setAttribute('animation',{
property:'position',
from:`${startX} ${startY} ${startZ}`,
to:`${targetX} ${targetY} ${targetZ}`,
dur:500 + Math.random() * 150,
easing:'easeInQuad'
});

drop.setAttribute('animation__opacity',{
property:'opacity',
from:'0.9',
to:'0',
dur:500
});

document.querySelector('a-scene').appendChild(drop);

// Remove drop after animation
setTimeout(()=>{
if(drop.parentNode){
drop.parentNode.removeChild(drop);
}
},550);
}
}

function checkDistanceForReaction(){
if(!tubeAElement||!tubeBElement || reactionStarted) return;
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);

// Calculate mixing based on poured amount
const mixAmount = Math.min(1.0, pouredAmount / MAX_POUR);

if(isPouringActive){
mixLiquids(mixAmount);
document.getElementById('status').textContent=`üíß POURING... ${Math.round(mixAmount*100)}% mixed`;
document.getElementById('status').style.color="#00ccff";
updateInstruction(`Tilt: ${Math.abs(pourAngle).toFixed(0)}¬∞ - Keep dragging UP`);
if(distance > 2.0){
updateInstruction(`‚ö†Ô∏è Tube is too far (${distance.toFixed(1)}) - Move closer to yellow tube`);
}
}else if(pouredAmount > 0){
mixLiquids(mixAmount);
document.getElementById('status').textContent=`‚öóÔ∏è Mixed: ${Math.round(mixAmount*100)}% - Drag UP to pour more`;
document.getElementById('status').style.color="#ff9900";
updateInstruction("‚¨ÜÔ∏è DRAG UP to continue pouring");
}else{
mixLiquids(0);
document.getElementById('status').textContent="Ready to pour - Drag UP";
document.getElementById('status').style.color="#ffffff";
updateInstruction("‚¨ÜÔ∏è DRAG UP to tilt and pour blue liquid");
}

// Check for reaction completion
if(pouredAmount >= MAX_POUR * 0.7 && !reactionStarted && distance < 2.0){
completeReaction();
}
}

function updateLiquidLevels(){
// Update blue liquid
const newHeightA = liquidLevelA * 0.45;
const newPositionA = 0.15 + (newHeightA/2);
const liquidA = document.querySelector('#liquidA');
const surfaceA = document.querySelector('#surfaceA');
if(liquidA){
liquidA.setAttribute('height', newHeightA);
liquidA.setAttribute('position', `0 ${newPositionA} 0`);
}
if(surfaceA){
surfaceA.setAttribute('position', `0 ${0.15 + newHeightA} 0`);
}

// Update yellow liquid
const newHeightB = liquidLevelB * 0.45;
const newPositionB = 0.15 + (newHeightB/2);
const liquidB = document.querySelector('#liquidB');
const surfaceB = document.querySelector('#surfaceB');
if(liquidB){
liquidB.setAttribute('height', newHeightB);
liquidB.setAttribute('position', `0 ${newPositionB} 0`);
}
if(surfaceB){
surfaceB.setAttribute('position', `0 ${0.15 + newHeightB} 0`);
}
}

function mixLiquids(mixAmount){
if(mixAmount<=0){
// Pure colors
const liquidA=document.querySelector('#liquidA');
const surfaceA=document.querySelector('#surfaceA');
const liquidB=document.querySelector('#liquidB');
const surfaceB=document.querySelector('#surfaceB');
if(liquidA) liquidA.setAttribute('color',BLUE_COLOR);
if(surfaceA) surfaceA.setAttribute('color',BLUE_COLOR);
if(liquidB) liquidB.setAttribute('color',YELLOW_COLOR);
if(surfaceB) surfaceB.setAttribute('color',YELLOW_COLOR);
}else if(mixAmount>=1.0){
// Complete reaction - vibrant green
const liquidA=document.querySelector('#liquidA');
const surfaceA=document.querySelector('#surfaceA');
const liquidB=document.querySelector('#liquidB');
const surfaceB=document.querySelector('#surfaceB');
if(liquidA) liquidA.setAttribute('color',GREEN_COLOR);
if(surfaceA) surfaceA.setAttribute('color',GREEN_COLOR);
if(liquidB) liquidB.setAttribute('color',GREEN_COLOR);
if(surfaceB) surfaceB.setAttribute('color',GREEN_COLOR);
}else{
// Smooth color blending
const blueR=parseInt(BLUE_COLOR.substr(1,2),16);
const blueG=parseInt(BLUE_COLOR.substr(3,2),16);
const blueB=parseInt(BLUE_COLOR.substr(5,2),16);
const yellowR=parseInt(YELLOW_COLOR.substr(1,2),16);
const yellowG=parseInt(YELLOW_COLOR.substr(3,2),16);
const yellowB=parseInt(YELLOW_COLOR.substr(5,2),16);

const blendFactor = Math.pow(mixAmount, 0.8);
const mixedR=Math.round(blueR+(yellowR-blueR)*blendFactor * 0.7);
const mixedG=Math.round(blueG+(yellowG-blueG)*blendFactor);
const mixedB=Math.round(blueB+(yellowB-blueB)*blendFactor * 0.5);
const mixedColor='#'+
mixedR.toString(16).padStart(2,'0')+
mixedG.toString(16).padStart(2,'0')+
mixedB.toString(16).padStart(2,'0');

const liquidA=document.querySelector('#liquidA');
const surfaceA=document.querySelector('#surfaceA');
const liquidB=document.querySelector('#liquidB');
const surfaceB=document.querySelector('#surfaceB');
if(liquidA) liquidA.setAttribute('color',mixedColor);
if(surfaceA) surfaceA.setAttribute('color',mixedColor);
if(liquidB) liquidB.setAttribute('color',mixedColor);
if(surfaceB) surfaceB.setAttribute('color',mixedColor);
}
}

function updatePositionInfo(){
if(tubeAElement&&tubeBElement){
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);
document.getElementById('position-info').innerHTML=
'üìè Distance: '+distance.toFixed(2)+'<br>'+
'‚¨ÜÔ∏è Tilt: '+Math.abs(pourAngle).toFixed(1)+'¬∞<br>'+
'üíß Poured: '+Math.round(pouredAmount/MAX_POUR*100)+'%<br>'+
'üîµ Blue: '+Math.round(liquidLevelA/0.45*100)+'%<br>'+
'üü° Yellow: '+Math.round(liquidLevelB/0.45*100)+'%';
}
}

function updateInstruction(message){
const instruction=document.querySelector('.instruction');
if(instruction){
instruction.innerHTML = message;
}
}

function updateStatus(){
if(tubeAVisible&&tubeBVisible){
if(reactionStarted){
document.getElementById('status').textContent="üß™ REACTION COMPLETE! Green solution created";
updateInstruction("‚úÖ Experiment successful! Press Reset to try again");
}else{
document.getElementById('status').textContent="Ready - Drag blue tube to pour";
}
}else if(tubeAVisible){
document.getElementById('status').textContent="Blue tube found - Scan yellow marker";
updateInstruction("üì∑ Point camera at YELLOW test tube marker");
}else if(tubeBVisible){
document.getElementById('status').textContent="Yellow tube found - Scan blue marker";
updateInstruction("üì∑ Point camera at BLUE test tube marker");
}else{
document.getElementById('status').textContent="Scan both markers to begin";
updateInstruction("üì∑ Point camera at both test tube markers");
}
}

function completeReaction(){
reactionStarted=true;
stopPouring();

// Final color
mixLiquids(1.0);
document.getElementById('status').textContent="üß™ REACTION COMPLETE!";
document.getElementById('status').style.color=GREEN_COLOR;
updateInstruction("‚úÖ Chemical reaction successful! Beautiful green solution created");

// Celebration bubbles
for(let i=0;i<25;i++){
setTimeout(()=>{
if(tubeBElement){
const pos=tubeBElement.object3D.position;
for(let j=0;j<3;j++){
createCelebrationBubble(pos.x + (Math.random()-0.5)*0.3, 
pos.y + 0.2 + Math.random()*0.3, 
pos.z + (Math.random()-0.5)*0.3);
}
}
}, i*80);
}
}

function createCelebrationBubble(x, y, z){
const bubble=document.createElement('a-sphere');
bubble.setAttribute('radius',0.015 + Math.random()*0.015);
bubble.setAttribute('color',GREEN_COLOR);
bubble.setAttribute('opacity',0.7 + Math.random()*0.3);
bubble.setAttribute('position',{x:x, y:y, z:z});

bubble.setAttribute('animation',{
property:'position',
to:`${x + (Math.random()-0.5)*0.2} ${y + 0.5 + Math.random()*0.5} ${z + (Math.random()-0.5)*0.2}`,
dur:1500,
easing:'easeOutQuad'
});

bubble.setAttribute('animation__opacity',{
property:'opacity',
to:'0',
dur:1500
});

document.querySelector('a-scene').appendChild(bubble);

setTimeout(()=>{
if(bubble.parentNode) bubble.parentNode.removeChild(bubble);
},1500);
}

function resetExperiment(){
reactionStarted=false;
isDragging=false;
isPouringActive=false;
pourAngle=0;
pouredAmount=0;
liquidLevelA=0.45;
liquidLevelB=0.45;
stopPouring();

if(tubeAElement){
tubeAElement.object3D.position.set(0,0,0);
tubeAElement.setAttribute('rotation', `0 ${markerARotation} 0`);
tubeStartPos={x:0,y:0,z:0};
}

updateLiquidLevels();
mixLiquids(0);

document.getElementById('status').textContent="Scan both markers";
document.getElementById('status').style.color="white";

updateStatus();
updatePositionInfo();
}
</script>
</head>

<body>

<div id="hud">
<h3>üß™ Chemical Mixing - Realistic Pouring</h3>
<p id="status">Scan both markers</p>
<button onclick="resetExperiment()">Reset Experiment</button>
</div>

<div class="position-info" id="position-info">
Distance: --<br>
Tilt: --¬∞<br>
Poured: --%<br>
Blue: --%<br>
Yellow: --%
</div>

<div class="instruction">
üì∑ Point camera at both test tube markers
</div>

<a-scene embedded arjs="debugUIEnabled:false;">

<a-light type="ambient" intensity="0.8"></a-light>
<a-light type="directional" position="1 2 1" intensity="0.6"></a-light>

<a-marker id="markerA" type="pattern" url="markers/testtube_markerA.patt">
<a-entity id="tubeA">
<!-- Glass tube -->
<a-cylinder radius="0.15" height="0.6" position="0 0.3 0" color="#ffffff" opacity="0.5" roughness="0.2" metalness="0.4" transparent="true"></a-cylinder>
<!-- Blue liquid -->
<a-cylinder id="liquidA" radius="0.13" height="0.45" position="0 0.225 0" color="#0066cc" opacity="0.95" roughness="0.1" metalness="0.1"></a-cylinder>
<!-- Liquid surface -->
<a-circle id="surfaceA" radius="0.13" position="0 0.45 0" color="#0066cc" opacity="0.95" rotation="-90 0 0"></a-circle>
</a-entity>
</a-marker>

<a-marker id="markerB" type="pattern" url="markers/testtube_markerB.patt">
<a-entity id="tubeB">
<!-- Glass tube -->
<a-cylinder radius="0.15" height="0.6" position="0 0.3 0" color="#ffffff" opacity="0.5" roughness="0.2" metalness="0.4" transparent="true"></a-cylinder>
<!-- Yellow liquid -->
<a-cylinder id="liquidB" radius="0.13" height="0.45" position="0 0.225 0" color="#ffcc00" opacity="0.95" roughness="0.1" metalness="0.1"></a-cylinder>
<!-- Liquid surface -->
<a-circle id="surfaceB" radius="0.13" position="0 0.45 0" color="#ffcc00" opacity="0.95" rotation="-90 0 0"></a-circle>
</a-entity>
</a-marker>

<a-entity camera></a-entity>

</a-scene>

</body>
</html>
