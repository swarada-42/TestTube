<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Chemical Mixing ‚Äì Visible Liquids</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 85%;
      border: 2px solid #0088ff;
    }
    .drop-counter {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,100,255,0.9);
      color: white;
      padding: 12px;
      border-radius: 10px;
      z-index: 1000;
      font-weight: bold;
    }
  </style>

  <script>
    // SIMPLE STATE - No complex logic
    let tubeAVisible = false;
    let tubeBVisible = false;
    let reactionDone = false;
    let dropCount = 0;
    
    // Initialize liquids when markers are found
    function initializeLiquids() {
      console.log("Initializing liquids...");
      
      // BLUE TUBE LIQUID
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      
      if (liquidA && surfaceA) {
        // Make sure liquid is visible and properly positioned
        liquidA.setAttribute("visible", "true");
        liquidA.setAttribute("height", "0.28");
        liquidA.setAttribute("position", "0 0.14 0");
        liquidA.setAttribute("color", "#0088ff");
        liquidA.setAttribute("opacity", "0.9");
        
        surfaceA.setAttribute("visible", "true");
        surfaceA.setAttribute("position", "0 0.28 0");
        surfaceA.setAttribute("color", "#0088ff");
        surfaceA.setAttribute("opacity", "0.9");
        
        console.log("Blue liquid initialized:", liquidA.getAttribute("position"));
      }
      
      // YELLOW TUBE LIQUID
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      
      if (liquidB && surfaceB) {
        liquidB.setAttribute("visible", "true");
        liquidB.setAttribute("height", "0.10");
        liquidB.setAttribute("position", "0 0.05 0");
        liquidB.setAttribute("color", "#ffff00");
        liquidB.setAttribute("opacity", "0.9");
        
        surfaceB.setAttribute("visible", "true");
        surfaceB.setAttribute("position", "0 0.10 0");
        surfaceB.setAttribute("color", "#ffff00");
        surfaceB.setAttribute("opacity", "0.9");
        
        console.log("Yellow liquid initialized:", liquidB.getAttribute("position"));
      }
    }
    
    // MARKER TRACKING - SIMPLE
    AFRAME.registerComponent("marker-tracker", {
      schema: { id: { type: "string" } },
      init() {
        this.el.addEventListener("markerFound", () => {
          console.log(`Marker ${this.data.id} found`);
          if (this.data.id === "A") {
            tubeAVisible = true;
            document.getElementById("marker-a-status").textContent = "‚úÖ BLUE";
            document.getElementById("marker-a-status").style.color = "#0088ff";
            
            // Initialize blue liquid
            setTimeout(() => {
              const liquidA = document.querySelector("#liquidA");
              if (liquidA) {
                liquidA.setAttribute("visible", "true");
                console.log("Blue liquid should be visible now");
              }
            }, 100);
          }
          if (this.data.id === "B") {
            tubeBVisible = true;
            document.getElementById("marker-b-status").textContent = "‚úÖ YELLOW";
            document.getElementById("marker-b-status").style.color = "#ffff00";
            
            // Initialize yellow liquid
            setTimeout(() => {
              const liquidB = document.querySelector("#liquidB");
              if (liquidB) {
                liquidB.setAttribute("visible", "true");
                console.log("Yellow liquid should be visible now");
              }
            }, 100);
          }
          updateStatus();
        });
        
        this.el.addEventListener("markerLost", () => {
          if (this.data.id === "A") {
            tubeAVisible = false;
            document.getElementById("marker-a-status").textContent = "‚ùå Not found";
            document.getElementById("marker-a-status").style.color = "#ff4444";
          }
          if (this.data.id === "B") {
            tubeBVisible = false;
            document.getElementById("marker-b-status").textContent = "‚ùå Not found";
            document.getElementById("marker-b-status").style.color = "#ff4444";
          }
          updateStatus();
        });
      }
    });
    
    // SIMPLE DROPLET SYSTEM
    AFRAME.registerComponent("simple-drop", {
      init: function () {
        console.log("Simple drop system ready");
        
        window.addEventListener("deviceorientation", (event) => {
          const tilt = event.beta || 0;
          document.getElementById("tilt-display").textContent = Math.round(tilt) + '¬∞';
          
          // Create drops when tilted
          if (tilt > 30 && tubeAVisible && tubeBVisible && !reactionDone) {
            this.createDrop();
          }
        });
      },
      
      createDrop: function () {
        dropCount++;
        document.getElementById("drop-count").textContent = dropCount;
        
        // Create droplet
        const drop = document.createElement("a-sphere");
        drop.setAttribute("radius", "0.04"); // Bigger for visibility
        drop.setAttribute("color", "#0088ff");
        drop.setAttribute("opacity", "1");
        drop.setAttribute("shader", "flat");
        
        // Position at blue tube's top
        drop.setAttribute("position", "0 0.28 0");
        
        // Add to blue tube
        this.el.appendChild(drop);
        
        // Animate drop
        this.animateDrop(drop);
      },
      
      animateDrop: function (drop) {
        let y = 0.28;
        const fall = setInterval(() => {
          y -= 0.02;
          drop.setAttribute("position", `0 ${y} 0`);
          
          if (y < -0.2 || reactionDone) {
            clearInterval(fall);
            if (drop.parentNode) {
              drop.parentNode.removeChild(drop);
            }
            
            // Update liquid levels after drop falls
            updateLiquidLevels();
          }
        }, 50);
      }
    });
    
    // SIMPLE LIQUID LEVEL UPDATE
    function updateLiquidLevels() {
      if (!tubeAVisible || !tubeBVisible || reactionDone) return;
      
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      
      if (!liquidA || !liquidB) return;
      
      // Get current heights
      let heightA = parseFloat(liquidA.getAttribute("height")) || 0.28;
      let heightB = parseFloat(liquidB.getAttribute("height")) || 0.10;
      
      // Reduce blue, increase yellow
      heightA = Math.max(0.05, heightA - 0.02);
      heightB = Math.min(0.46, heightB + 0.02);
      
      // Update blue tube (gets empty)
      liquidA.setAttribute("height", heightA);
      liquidA.setAttribute("position", `0 ${heightA/2} 0`);
      if (surfaceA) surfaceA.setAttribute("position", `0 ${heightA} 0`);
      
      // Update yellow tube (becomes green)
      liquidB.setAttribute("height", heightB);
      liquidB.setAttribute("position", `0 ${heightB/2} 0`);
      if (surfaceB) surfaceB.setAttribute("position", `0 ${heightB} 0`);
      
      // Change color based on mixing
      if (heightB > 0.25) {
        liquidB.setAttribute("color", "#00ff00");
        if (surfaceB) surfaceB.setAttribute("color", "#00ff00");
      } else if (heightB > 0.15) {
        liquidB.setAttribute("color", "#aaff00");
        if (surfaceB) surfaceB.setAttribute("color", "#aaff00");
      }
      
      // Check if reaction is complete (blue empty)
      if (heightA <= 0.06) {
        triggerReaction();
      }
    }
    
    // SIMPLE REACTION
    function triggerReaction() {
      if (reactionDone) return;
      
      reactionDone = true;
      console.log("Reaction complete!");
      
      // Make blue tube empty (almost invisible)
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("opacity", "0.2");
        surfaceA.setAttribute("opacity", "0.2");
      }
      
      // Make yellow tube bright green
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("color", "#00ff00");
        surfaceB.setAttribute("color", "#00ff00");
      }
      
      // Update HUD
      document.getElementById("reaction-status").textContent = "üéâ REACTION COMPLETE!";
      document.getElementById("reaction-status").style.color = "#00ff00";
      document.getElementById("experiment-status").innerHTML = 
        "<span style='color:#00ff00'>üéä Blue Empty + Yellow = Green!</span>";
    }
    
    // UPDATE STATUS
    function updateStatus() {
      const status = document.getElementById("experiment-status");
      if (tubeAVisible && tubeBVisible) {
        status.innerHTML = reactionDone ? 
          "<span style='color:#00ff00'>üéâ REACTION COMPLETE!</span>" :
          "<span style='color:#00ff00'>‚úÖ READY! Tilt phone forward</span>";
      } else if (tubeAVisible) {
        status.innerHTML = "<span style='color:#0088ff'>üîµ Blue tube ready</span>";
      } else if (tubeBVisible) {
        status.innerHTML = "<span style='color:#ffff00'>üü° Yellow tube ready</span>";
      } else {
        status.innerHTML = "<span style='color:#ff4444'>üëÜ Show markers</span>";
      }
    }
    
    // RESET FUNCTION
    window.resetExperiment = function() {
      console.log("Resetting...");
      
      reactionDone = false;
      dropCount = 0;
      
      // Reset blue tube (FULL)
      const liquidA = document.querySelector("#liquidA");
      const surfaceA = document.querySelector("#surfaceA");
      if (liquidA && surfaceA) {
        liquidA.setAttribute("height", "0.28");
        liquidA.setAttribute("position", "0 0.14 0");
        liquidA.setAttribute("color", "#0088ff");
        liquidA.setAttribute("opacity", "0.9");
        liquidA.setAttribute("visible", "true");
        
        surfaceA.setAttribute("position", "0 0.28 0");
        surfaceA.setAttribute("color", "#0088ff");
        surfaceA.setAttribute("opacity", "0.9");
        surfaceA.setAttribute("visible", "true");
      }
      
      // Reset yellow tube (STARTING)
      const liquidB = document.querySelector("#liquidB");
      const surfaceB = document.querySelector("#surfaceB");
      if (liquidB && surfaceB) {
        liquidB.setAttribute("height", "0.10");
        liquidB.setAttribute("position", "0 0.05 0");
        liquidB.setAttribute("color", "#ffff00");
        liquidB.setAttribute("opacity", "0.9");
        liquidB.setAttribute("visible", "true");
        
        surfaceB.setAttribute("position", "0 0.10 0");
        surfaceB.setAttribute("color", "#ffff00");
        surfaceB.setAttribute("opacity", "0.9");
        surfaceB.setAttribute("visible", "true");
      }
      
      // Update HUD
      document.getElementById("drop-count").textContent = "0";
      document.getElementById("reaction-status").textContent = "Not reacted";
      document.getElementById("reaction-status").style.color = "white";
      document.getElementById("tilt-display").textContent = "0¬∞";
      
      updateStatus();
    };
    
    // Initialize on load
    window.onload = function() {
      console.log("Page loaded, initializing...");
      setTimeout(initializeLiquids, 1000);
    };

  </script>

</head>

<body style="margin:0; overflow:hidden;">
  <!-- HUD Display -->
  <div id="hud">
    <h2 style="margin: 0 0 10px 0; color: #00aaff;">üß™ SIMPLE CHEMICAL MIXING</h2>
    <p><strong>Status:</strong> <span id="experiment-status">Show markers</span></p>
    <p><strong>Tilt:</strong> <span id="tilt-display">0¬∞</span></p>
    <p><strong>Markers:</strong> 
      <span id="marker-a-status" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Blue</span> 
      <span id="marker-b-status" style="padding: 3px 10px; border-radius: 5px; background: #222;">‚ùå Yellow</span>
    </p>
    <p><strong>Reaction:</strong> <span id="reaction-status">Not reacted</span></p>
    <button onclick="resetExperiment()" 
            style="margin-top: 10px; padding: 8px 15px; background: #ff4444; 
                   color: white; border: none; border-radius: 5px; font-weight: bold;
                   cursor: pointer; width: 100%;">
      üîÑ Reset
    </button>
  </div>
  
  <!-- Drop Counter -->
  <div class="drop-counter">
    üíß Drops: <span id="drop-count">0</span>
  </div>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="debugUIEnabled:false;"
    renderer="antialias: true; alpha: true;"
    device-orientation-permission-ui="enabled: true">

    <!-- Lights -->
    <a-light type="ambient" color="#ffffff" intensity="0.9"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.8" cast-shadow></a-light>

    <!-- ========== TEST TUBE A (BLUE) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerA.patt"
      marker-tracker="id: A"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">

      <a-entity id="tubeA" simple-drop position="0 0 0">
        <!-- Glass Tube (VERY TRANSPARENT) -->
        <a-cylinder
          radius="0.15"
          height="0.6"
          position="0 0.3 0"
          color="#ffffff"
          opacity="0.1"
          transparent="true"
          roughness="0.2"
          metalness="0.3">
        </a-cylinder>

        <!-- BLUE LIQUID (HIGHLY VISIBLE) -->
        <a-cylinder
          id="liquidA"
          radius="0.13"
          height="0.28"
          position="0 0.14 0"
          color="#0088ff"
          opacity="0.95"
          roughness="0.1"
          metalness="0.1"
          visible="true">
        </a-cylinder>

        <!-- Liquid Surface -->
        <a-circle
          id="surfaceA"
          radius="0.13"
          position="0 0.28 0"
          color="#0088ff"
          opacity="0.95"
          rotation="-90 0 0"
          side="double"
          visible="true">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- ========== TEST TUBE B (YELLOW) ========= -->
    <a-marker
      type="pattern"
      url="markers/testtube_markerB.patt"
      marker-tracker="id: B"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01">

      <a-entity position="0 0 0">
        <!-- Glass Tube -->
        <a-cylinder
          radius="0.15"
          height="0.7"
          position="0 0.35 0"
          color="#ffffff"
          opacity="0.1"
          transparent="true"
          roughness="0.2"
          metalness="0.3">
        </a-cylinder>

        <!-- YELLOW/GREEN LIQUID -->
        <a-cylinder
          id="liquidB"
          radius="0.13"
          height="0.10"
          position="0 0.05 0"
          color="#ffff00"
          opacity="0.95"
          roughness="0.1"
          metalness="0.1"
          visible="true">
        </a-cylinder>

        <!-- Liquid Surface -->
        <a-circle
          id="surfaceB"
          radius="0.13"
          position="0 0.10 0"
          color="#ffff00"
          opacity="0.95"
          rotation="-90 0 0"
          side="double"
          visible="true">
        </a-circle>

      </a-entity>

    </a-marker>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Instructions -->
  <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
              background: rgba(0,0,0,0.95); color: white; padding: 15px; 
              border-radius: 10px; text-align: center; max-width: 95%; z-index: 1000;
              border: 3px solid #00ff88;">
    <h3 style="margin: 0 0 10px 0;">üéØ WHAT TO LOOK FOR:</h3>
    <p style="margin: 5px 0; color: #0088ff;">1. <strong>Blue liquid</strong> in left test tube</p>
    <p style="margin: 5px 0; color: #ffff00;">2. <strong>Yellow liquid</strong> in right test tube</p>
    <p style="margin: 5px 0; color: #00ff88;">3. <strong>Tilt phone</strong> to pour blue into yellow</p>
    <p style="margin: 5px 0; color: #ffaa00;">4. Watch blue empty, yellow become green!</p>
    <p style="margin: 10px 0 0 0; font-size: 12px; color: #aaa;">
      If liquids not visible: Check console (F12) for errors
    </p>
  </div>
  
  <!-- Debug button -->
  <button onclick="showDebugInfo()" 
          style="position: absolute; bottom: 200px; right: 10px; 
                 background: #333; color: white; padding: 5px 10px;
                 border: none; border-radius: 5px; font-size: 12px;">
    üîç Debug
  </button>
  
  <script>
    function showDebugInfo() {
      const liquidA = document.querySelector("#liquidA");
      const liquidB = document.querySelector("#liquidB");
      
      console.log("=== DEBUG INFO ===");
      console.log("Liquid A exists:", !!liquidA);
      console.log("Liquid A visible:", liquidA ? liquidA.getAttribute("visible") : "N/A");
      console.log("Liquid A position:", liquidA ? liquidA.getAttribute("position") : "N/A");
      console.log("Liquid B exists:", !!liquidB);
      console.log("Liquid B visible:", liquidB ? liquidB.getAttribute("visible") : "N/A");
      console.log("Liquid B position:", liquidB ? liquidB.getAttribute("position") : "N/A");
      console.log("Tube A visible:", tubeAVisible);
      console.log("Tube B visible:", tubeBVisible);
      console.log("==================");
      
      alert("Check browser console (F12) for debug information");
    }
  </script>
</body>
</html>
