<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chemical Mixing - TestTube Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: black;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 85%;
      border: 2px solid #0088ff;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 1001;
      border: 3px solid #ff8800;
    }
    .action-btn {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: #0088ff;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
    }
    canvas {
      display: block;
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loading">
    <h2>üß™ Loading Chemical Experiment...</h2>
    <p id="load-status">Initializing 3D Engine</p>
    <div style="margin: 20px 0; height: 10px; background: #333; border-radius: 5px;">
      <div id="progress-bar" style="width: 0%; height: 100%; background: #0088ff; border-radius: 5px; transition: width 0.3s;"></div>
    </div>
    <p style="color: #aaa; font-size: 14px;">Please allow camera access when prompted</p>
  </div>
  
  <!-- HUD -->
  <div id="hud" style="display: none;">
    <h3 style="margin: 0 0 10px 0; color: #00aaff;">üß™ TEST TUBE EXPERIMENT</h3>
    <p><strong>Status:</strong> <span id="status">Show markers to camera</span></p>
    <p><strong>Blue Tube:</strong> <span id="blue-status">‚ùå Waiting for marker...</span></p>
    <p><strong>Yellow Tube:</strong> <span id="yellow-status">‚ùå Waiting for marker...</span></p>
    <p><strong>Reaction:</strong> <span id="reaction-status">Not started</span></p>
    <div style="margin-top: 15px;">
      <button onclick="startPouring()" style="margin-right: 10px; padding: 8px 15px; background: #0088ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
        ü´ó START POURING
      </button>
      <button onclick="resetExperiment()" style="padding: 8px 15px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
        üîÑ RESET
      </button>
    </div>
  </div>
  
  <!-- Canvas -->
  <div id="canvas-container"></div>

  <script>
    // ========== CONFIGURATION ==========
    // Using YOUR GitHub repository URLs
    const GITHUB_USERNAME = 'swarada-42';
    const REPO_NAME = 'TestTube';
    const BRANCH = 'main'; // or 'master' depending on your repo
    
    // Marker URLs from YOUR GitHub repository
    const MARKER_A_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${BRANCH}/markers/testtube_markerA.patt`;
    const MARKER_B_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${BRANCH}/markers/testtube_markerB.patt`;
    
    console.log("Using marker URLs:");
    console.log("Marker A:", MARKER_A_URL);
    console.log("Marker B:", MARKER_B_URL);
    
    // ========== GLOBAL VARIABLES ==========
    let scene, camera, renderer;
    let arToolkitSource, arToolkitContext;
    let blueTube, yellowTube;
    let blueLiquid, yellowLiquid;
    let isPouring = false;
    let reactionDone = false;
    let blueLevel = 1.0;
    let yellowLevel = 0.2;
    let loadProgress = 0;
    
    // ========== LOADING FUNCTIONS ==========
    function updateLoadStatus(message, progress) {
      document.getElementById('load-status').textContent = message;
      loadProgress = progress;
      document.getElementById('progress-bar').style.width = progress + '%';
      console.log("Load:", message);
    }
    
    // ========== INITIALIZATION ==========
    function init() {
      updateLoadStatus("Initializing 3D Engine...", 10);
      
      // Create scene
      scene = new THREE.Scene();
      
      // Create camera
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      
      // Create renderer
      renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: true,
        preserveDrawingBuffer: true
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      document.getElementById('canvas-container').appendChild(renderer.domElement);
      
      updateLoadStatus("Adding lighting...", 20);
      
      // Add lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(1, 2, 1);
      scene.add(directionalLight);
      
      updateLoadStatus("Creating 3D models...", 40);
      
      // Create test tubes
      createTestTubes();
      
      updateLoadStatus("Setting up AR system...", 60);
      
      // Initialize AR
      initAR();
      
      updateLoadStatus("Starting animation...", 80);
      
      // Start animation loop
      animate();
      
      // Show HUD and hide loading
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        updateLoadStatus("Ready! Show markers", 100);
      }, 500);
      
      console.log("‚úÖ Three.js AR Experiment Initialized");
    }
    
    // ========== CREATE 3D TEST TUBES ==========
    function createTestTubes() {
      // BLUE TEST TUBE
      const blueTubeGroup = new THREE.Group();
      blueTubeGroup.name = "blueTube";
      
      // Glass cylinder
      const glassGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.6, 32);
      const glassMaterial = new THREE.MeshPhongMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.2
      });
      const blueGlass = new THREE.Mesh(glassGeometry, glassMaterial);
      blueGlass.position.y = 0.3;
      blueTubeGroup.add(blueGlass);
      
      // Blue liquid cylinder
      const liquidGeometry = new THREE.CylinderGeometry(0.13, 0.13, 0.5, 32);
      const blueMaterial = new THREE.MeshPhongMaterial({
        color: 0x0088ff,
        transparent: true,
        opacity: 0.9
      });
      blueLiquid = new THREE.Mesh(liquidGeometry, blueMaterial);
      blueLiquid.position.y = 0.25; // Half of 0.5
      blueLiquid.scale.y = blueLevel;
      blueTubeGroup.add(blueLiquid);
      
      // Liquid surface (disc)
      const surfaceGeometry = new THREE.CircleGeometry(0.13, 32);
      const blueSurface = new THREE.Mesh(surfaceGeometry, blueMaterial);
      blueSurface.rotation.x = -Math.PI / 2; // Make it horizontal
      blueSurface.position.y = 0.5; // Top of liquid
      blueTubeGroup.add(blueSurface);
      
      blueTube = blueTubeGroup;
      blueTube.visible = false;
      scene.add(blueTube);
      
      // YELLOW TEST TUBE
      const yellowTubeGroup = new THREE.Group();
      yellowTubeGroup.name = "yellowTube";
      
      // Glass
      const yellowGlass = new THREE.Mesh(glassGeometry, glassMaterial);
      yellowGlass.position.y = 0.3;
      yellowTubeGroup.add(yellowGlass);
      
      // Yellow liquid
      const yellowMaterial = new THREE.MeshPhongMaterial({
        color: 0xffff00,
        transparent: true,
        opacity: 0.9
      });
      yellowLiquid = new THREE.Mesh(liquidGeometry, yellowMaterial);
      yellowLiquid.position.y = 0.1; // Lower starting point
      yellowLiquid.scale.y = yellowLevel;
      yellowTubeGroup.add(yellowLiquid);
      
      // Yellow surface
      const yellowSurface = new THREE.Mesh(surfaceGeometry, yellowMaterial);
      yellowSurface.rotation.x = -Math.PI / 2;
      yellowSurface.position.y = 0.2; // Top of starting liquid
      yellowTubeGroup.add(yellowSurface);
      
      yellowTube = yellowTubeGroup;
      yellowTube.visible = false;
      scene.add(yellowTube);
      
      console.log("‚úÖ 3D Test Tubes Created");
    }
    
    // ========== INITIALIZE AR ==========
    function initAR() {
      updateLoadStatus("Accessing camera...", 70);
      
      // Create AR source (webcam)
      arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
        sourceWidth: 640,
        sourceHeight: 480,
        displayWidth: window.innerWidth,
        displayHeight: window.innerHeight
      });
      
      arToolkitSource.init(() => {
        console.log("‚úÖ Webcam initialized");
        arToolkitSource.onResize();
        updateLoadStatus("Camera ready", 75);
      });
      
      // Create AR context
      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
        detectionMode: 'mono',
        maxDetectionRate: 30,
        canvasWidth: window.innerWidth,
        canvasHeight: window.innerHeight,
      });
      
      arToolkitContext.init(() => {
        console.log("‚úÖ AR Context initialized");
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
        updateLoadStatus("Setting up markers...", 85);
        
        // Create marker controls after context is ready
        createMarkerControls();
      });
    }
    
    // ========== CREATE MARKER CONTROLS ==========
    function createMarkerControls() {
      console.log("üìå Creating marker controls with URLs:");
      console.log("Marker A:", MARKER_A_URL);
      console.log("Marker B:", MARKER_B_URL);
      
      // Create root objects for markers
      const markerRootA = new THREE.Group();
      markerRootA.visible = false;
      scene.add(markerRootA);
      
      const markerRootB = new THREE.Group();
      markerRootB.visible = false;
      scene.add(markerRootB);
      
      // Marker A Controls (Blue Tube)
      const markerControlsA = new THREEx.ArMarkerControls(arToolkitContext, markerRootA, {
        type: 'pattern',
        patternUrl: MARKER_A_URL,
        changeMatrixMode: 'cameraTransformMatrix'
      });
      
      // Marker B Controls (Yellow Tube)
      const markerControlsB = new THREEx.ArMarkerControls(arToolkitContext, markerRootB, {
        type: 'pattern',
        patternUrl: MARKER_B_URL,
        changeMatrixMode: 'cameraTransformMatrix'
      });
      
      // Marker A Events
      markerControlsA.addEventListener('markerFound', () => {
        console.log("‚úÖ Marker A (Blue Tube) detected!");
        blueTube.visible = true;
        blueTube.position.set(0, 0, 0);
        blueTube.scale.set(1, 1, 1);
        markerRootA.add(blueTube);
        
        // Update HUD
        document.getElementById('blue-status').textContent = "‚úÖ Found";
        document.getElementById('blue-status').style.color = "#0088ff";
        document.getElementById('status').textContent = "Blue tube ready";
        
        if (yellowTube.visible) {
          document.getElementById('status').textContent = "‚úÖ Both tubes ready! Click POUR";
        }
      });
      
      markerControlsA.addEventListener('markerLost', () => {
        console.log("Marker A lost");
        blueTube.visible = false;
        scene.add(blueTube);
        document.getElementById('blue-status').textContent = "‚ùå Not found";
        document.getElementById('blue-status').style.color = "#ff4444";
      });
      
      // Marker B Events
      markerControlsB.addEventListener('markerFound', () => {
        console.log("‚úÖ Marker B (Yellow Tube) detected!");
        yellowTube.visible = true;
        yellowTube.position.set(0, 0, 0);
        yellowTube.scale.set(1, 1, 1);
        markerRootB.add(yellowTube);
        
        // Update HUD
        document.getElementById('yellow-status').textContent = "‚úÖ Found";
        document.getElementById('yellow-status').style.color = "#ffff00";
        document.getElementById('status').textContent = "Yellow tube ready";
        
        if (blueTube.visible) {
          document.getElementById('status').textContent = "‚úÖ Both tubes ready! Click POUR";
        }
      });
      
      markerControlsB.addEventListener('markerLost', () => {
        console.log("Marker B lost");
        yellowTube.visible = false;
        scene.add(yellowTube);
        document.getElementById('yellow-status').textContent = "‚ùå Not found";
        document.getElementById('yellow-status').style.color = "#ff4444";
      });
      
      console.log("‚úÖ Marker controls created");
      updateLoadStatus("Ready to scan markers", 100);
    }
    
    // ========== POURING SYSTEM ==========
    function startPouring() {
      if (!blueTube.visible || !yellowTube.visible) {
        alert("Please show both markers first!");
        return;
      }
      
      if (reactionDone) {
        alert("Reaction already complete! Click RESET to start over.");
        return;
      }
      
      console.log("Starting pouring animation...");
      isPouring = true;
      document.getElementById('status').textContent = "Pouring...";
      document.getElementById('status').style.color = "#0088ff";
      
      // Start pouring animation
      const pourInterval = setInterval(() => {
        if (blueLevel > 0.1 && !reactionDone) {
          // Transfer liquid
          blueLevel -= 0.02;
          yellowLevel += 0.02;
          
          // Clamp values
          blueLevel = Math.max(0.1, blueLevel);
          yellowLevel = Math.min(1.0, yellowLevel);
          
          // Update 3D visuals
          updateLiquidVisuals();
          
          // Create droplet animation
          createDroplet();
          
          // Check if reaction complete
          if (blueLevel <= 0.11) {
            completeReaction();
            clearInterval(pourInterval);
          }
        } else {
          clearInterval(pourInterval);
          isPouring = false;
        }
      }, 200);
    }
    
    function updateLiquidVisuals() {
      // Update blue liquid
      blueLiquid.scale.y = blueLevel;
      blueLiquid.position.y = 0.25 * blueLevel;
      
      // Update yellow liquid
      yellowLiquid.scale.y = yellowLevel;
      yellowLiquid.position.y = 0.1 + (0.15 * yellowLevel); // Adjust position as it fills
      
      // Color mixing (yellow -> green)
      const mixRatio = (yellowLevel - 0.2) / 0.8;
      if (mixRatio > 0.5) {
        // Mix to green
        const greenValue = Math.min(255, 150 + (mixRatio * 105));
        yellowLiquid.material.color.setRGB(
          1 - mixRatio,
          greenValue / 255,
          mixRatio * 0.5
        );
      }
      
      // Update HUD percentages
      document.getElementById('blue-status').textContent = `‚úÖ ${Math.round(blueLevel * 100)}%`;
      document.getElementById('yellow-status').textContent = `‚úÖ ${Math.round(yellowLevel * 100)}%`;
    }
    
    function createDroplet() {
      // Create a simple droplet animation
      const geometry = new THREE.SphereGeometry(0.02, 16, 16);
      const material = new THREE.MeshPhongMaterial({ color: 0x0088ff });
      const droplet = new THREE.Mesh(geometry, material);
      
      // Position at blue tube
      droplet.position.copy(blueTube.position);
      droplet.position.y += 0.3;
      
      scene.add(droplet);
      
      // Animate falling
      let life = 50;
      function animateDroplet() {
        if (life > 0) {
          droplet.position.y -= 0.02;
          life--;
          requestAnimationFrame(animateDroplet);
        } else {
          scene.remove(droplet);
        }
      }
      animateDroplet();
    }
    
    function completeReaction() {
      console.log("üéâ Reaction Complete!");
      reactionDone = true;
      isPouring = false;
      
      // Visual effects
      blueLiquid.material.opacity = 0.3; // Make it look empty
      yellowLiquid.material.color.setHex(0x00ff00); // Bright green
      
      // Update HUD
      document.getElementById('status').textContent = "üéâ REACTION COMPLETE!";
      document.getElementById('status').style.color = "#00ff00";
      document.getElementById('reaction-status').textContent = "‚úÖ Blue + Yellow = Green!";
      document.getElementById('reaction-status').style.color = "#00ff00";
    }
    
    // ========== ANIMATION LOOP ==========
    function animate() {
      requestAnimationFrame(animate);
      
      // Update AR if ready
      if (arToolkitSource && arToolkitSource.ready) {
        arToolkitContext.update(arToolkitSource.domElement);
      }
      
      // Render scene
      renderer.render(scene, camera);
    }
    
    // ========== RESET FUNCTION ==========
    function resetExperiment() {
      console.log("Resetting experiment...");
      
      isPouring = false;
      reactionDone = false;
      blueLevel = 1.0;
      yellowLevel = 0.2;
      
      // Reset 3D visuals
      blueLiquid.scale.y = blueLevel;
      blueLiquid.material.opacity = 0.9;
      blueLiquid.material.color.setHex(0x0088ff);
      
      yellowLiquid.scale.y = yellowLevel;
      yellowLiquid.material.color.setHex(0xffff00);
      yellowLiquid.position.y = 0.1;
      
      // Reset HUD
      document.getElementById('status').textContent = "Show markers to camera";
      document.getElementById('status').style.color = "white";
      document.getElementById('reaction-status').textContent = "Not started";
      document.getElementById('reaction-status').style.color = "white";
      
      // Only update marker status if tubes are visible
      if (blueTube.visible) {
        document.getElementById('blue-status').textContent = "‚úÖ Found";
        document.getElementById('blue-status').style.color = "#0088ff";
      }
      if (yellowTube.visible) {
        document.getElementById('yellow-status').textContent = "‚úÖ Found";
        document.getElementById('yellow-status').style.color = "#ffff00";
      }
      
      console.log("‚úÖ Experiment reset");
    }
    
    // ========== EVENT LISTENERS ==========
    window.addEventListener('resize', () => {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      if (arToolkitSource) {
        arToolkitSource.onResize();
      }
    });
    
    // Tilt detection for mobile
    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', (event) => {
        const tilt = Math.abs(event.beta || 0);
        if (tilt > 40 && blueTube.visible && yellowTube.visible && !isPouring && !reactionDone) {
          startPouring();
        }
      });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      switch(event.key) {
        case ' ':
          startPouring();
          break;
        case 'r':
        case 'R':
          resetExperiment();
          break;
      }
    });
    
    // ========== START APPLICATION ==========
    window.onload = init;
    
    // Expose functions to global scope
    window.startPouring = startPouring;
    window.resetExperiment = resetExperiment;

  </script>
  
  <!-- Instructions -->
  <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
              background: rgba(0,0,0,0.95); color: white; padding: 15px; 
              border-radius: 10px; text-align: center; max-width: 95%; z-index: 1000;
              border: 3px solid #00ff88;">
    <h4 style="margin: 0 0 10px 0;">üéØ HOW TO USE:</h4>
    <p style="margin: 5px 0; color: #0088ff;">1. Show <strong>testtube_markerA.patt</strong> to camera</p>
    <p style="margin: 5px 0; color: #ffff00;">2. Show <strong>testtube_markerB.patt</strong> to camera</p>
    <p style="margin: 5px 0; color: #00ff88;">3. Click <strong>START POURING</strong> button</p>
    <p style="margin: 5px 0; color: #ffaa00;">4. Watch blue liquid turn yellow to green!</p>
    <p style="margin: 10px 0 0 0; font-size: 12px; color: #aaa;">
      Running from: <strong>https://swarada-42.github.io/TestTube/</strong>
    </p>
  </div>
</body>
</html>
