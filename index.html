<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Chemical Mixing</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

<style>
body{margin:0;overflow:hidden;font-family:Arial;}
#hud{
position:absolute;
top:10px;
left:10px;
background:rgba(0,0,0,0.8);
color:white;
padding:10px;
border-radius:10px;
z-index:1000;
}
button{
background:#4CAF50;
color:white;
border:none;
padding:8px 16px;
border-radius:5px;
cursor:pointer;
}
.position-info{
position:absolute;
top:10px;
right:10px;
background:rgba(0,0,0,0.7);
color:white;
padding:5px 10px;
border-radius:5px;
font-size:12px;
z-index:1000;
}
.instruction{
position:absolute;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:rgba(0,100,200,0.9);
color:white;
padding:10px 20px;
border-radius:10px;
text-align:center;
max-width:80%;
z-index:1000;
}
</style>

<script>
let tubeAVisible=false;
let tubeBVisible=false;
let isDragging=false;
let isPouring=false;
let reactionStarted=false;
let tubeAElement=null;
let tubeBElement=null;

let dragStartScreenX=0;
let dragStartScreenY=0;
let tubeStartPos={x:0,y:0,z:0};

const BLUE_COLOR='#0088ff';
const YELLOW_COLOR='#ffff00';
const GREEN_COLOR='#00ff00';

let liquidLevelA=0.45;
let liquidLevelB=0.45;
let pourAngle=0;
let isPouringActive=false;
let pourInterval=null;
let pouredAmount=0;
const MAX_POUR=0.35;

document.addEventListener('DOMContentLoaded',function(){
const scene=document.querySelector('a-scene');

scene.addEventListener('markerFound',function(e){
if(e.target.id==='markerA'){
tubeAVisible=true;
tubeAElement=document.querySelector('#tubeA');
document.getElementById('status').textContent="Blue tube found";
}
if(e.target.id==='markerB'){
tubeBVisible=true;
tubeBElement=document.querySelector('#tubeB');
document.getElementById('status').textContent="Yellow tube found";
}
if(tubeAVisible && tubeBVisible){
document.getElementById('status').textContent="Ready - Drag blue tube";
updatePositionInfo();
updateInstruction("Drag blue tube close to yellow tube");
}
});

scene.addEventListener('markerLost',function(e){
if(e.target.id==='markerA'){
tubeAVisible=false;
}
if(e.target.id==='markerB'){
tubeBVisible=false;
}
updateStatus();
});

// Mouse events for laptop/desktop
scene.addEventListener('mousedown',function(e){
if(reactionStarted || !tubeAVisible || !tubeBVisible) return;
e.preventDefault();
e.stopPropagation();
dragStartScreenX=e.clientX;
dragStartScreenY=e.clientY;
if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}
isDragging=true;
document.getElementById('status').textContent="Dragging...";
updateInstruction("Drag toward yellow tube");
});

scene.addEventListener('mousemove',function(e){
if(!isDragging || !tubeAElement) return;
e.preventDefault();
e.stopPropagation();
const currentScreenX=e.clientX;
const currentScreenY=e.clientY;
const deltaScreenX=currentScreenX-dragStartScreenX;
const deltaScreenY=currentScreenY-dragStartScreenY;
const speedFactor=0.005;
const deltaX=deltaScreenX*speedFactor;
const deltaZ=deltaScreenY*speedFactor;
const newX=tubeStartPos.x+deltaX;
const newZ=tubeStartPos.z+deltaZ;
tubeAElement.object3D.position.x=newX;
tubeAElement.object3D.position.z=newZ;

// Calculate tilt angle based on drag direction and distance
if(isCloseEnoughForPouring()){
// When close enough, tilt based on vertical drag
pourAngle = Math.max(0, Math.min(-90, -deltaScreenY * 0.5));
tubeAElement.setAttribute('rotation', `${pourAngle} 0 0`);
isPouringActive = pourAngle < -20;
updateInstruction(isPouringActive ? "Pouring liquid! Drag up for more" : "Drag up to tilt and pour");
}else{
// Normal dragging tilt
const tiltAngle = Math.min(30, Math.abs(deltaScreenY) * 0.1);
const tiltDirection = deltaScreenY > 0 ? -tiltAngle : tiltAngle;
tubeAElement.setAttribute('rotation', `${tiltDirection} 0 0`);
isPouringActive = false;
updateInstruction("Get closer to yellow tube to pour");
}

updatePositionInfo();
checkDistanceForReaction();

// If pouring is active, create pouring effect
if(isPouringActive && isCloseEnoughForPouring()){
startPouring();
}else{
stopPouring();
}
});

scene.addEventListener('mouseup',function(e){
if(!isDragging) return;
isDragging=false;
isPouringActive=false;
stopPouring();

if(tubeAElement){
tubeAElement.setAttribute('rotation','0 0 0');
}

if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}

if(!reactionStarted && isCloseEnoughForReaction()){
completeReaction();
}else{
document.getElementById('status').textContent="Ready - Drag blue tube";
updateInstruction("Drag blue tube close to yellow tube");
}
});

// Touch events for mobile
scene.addEventListener('touchstart',function(e){
if(reactionStarted || !tubeAVisible || !tubeBVisible) return;
e.preventDefault();
e.stopPropagation();
const touch=e.touches[0];
dragStartScreenX=touch.clientX;
dragStartScreenY=touch.clientY;
if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}
isDragging=true;
document.getElementById('status').textContent="Dragging...";
updateInstruction("Drag toward yellow tube");
});

scene.addEventListener('touchmove',function(e){
if(!isDragging || !tubeAElement) return;
e.preventDefault();
e.stopPropagation();
const touch=e.touches[0];
const currentScreenX=touch.clientX;
const currentScreenY=touch.clientY;
const deltaScreenX=currentScreenX-dragStartScreenX;
const deltaScreenY=currentScreenY-dragStartScreenY;
const speedFactor=0.005;
const deltaX=deltaScreenX*speedFactor;
const deltaZ=deltaScreenY*speedFactor;
const newX=tubeStartPos.x+deltaX;
const newZ=tubeStartPos.z+deltaZ;
tubeAElement.object3D.position.x=newX;
tubeAElement.object3D.position.z=newZ;

// Calculate tilt angle based on drag direction and distance
if(isCloseEnoughForPouring()){
// When close enough, tilt based on vertical drag
pourAngle = Math.max(0, Math.min(-90, -deltaScreenY * 0.5));
tubeAElement.setAttribute('rotation', `${pourAngle} 0 0`);
isPouringActive = pourAngle < -20;
updateInstruction(isPouringActive ? "Pouring liquid! Drag up for more" : "Drag up to tilt and pour");
}else{
// Normal dragging tilt
const tiltAngle = Math.min(30, Math.abs(deltaScreenY) * 0.1);
const tiltDirection = deltaScreenY > 0 ? -tiltAngle : tiltAngle;
tubeAElement.setAttribute('rotation', `${tiltDirection} 0 0`);
isPouringActive = false;
updateInstruction("Get closer to yellow tube to pour");
}

updatePositionInfo();
checkDistanceForReaction();

// If pouring is active, create pouring effect
if(isPouringActive && isCloseEnoughForPouring()){
startPouring();
}else{
stopPouring();
}
});

scene.addEventListener('touchend',function(e){
if(!isDragging) return;
isDragging=false;
isPouringActive=false;
stopPouring();

if(tubeAElement){
tubeAElement.setAttribute('rotation','0 0 0');
}

if(tubeAElement && tubeAElement.object3D){
const pos=tubeAElement.object3D.position;
tubeStartPos={x:pos.x,y:pos.y,z:pos.z};
}

if(!reactionStarted && isCloseEnoughForReaction()){
completeReaction();
}else{
document.getElementById('status').textContent="Ready - Drag blue tube";
updateInstruction("Drag blue tube close to yellow tube");
}
});

// Prevent default click behavior
scene.addEventListener('click',function(e){
e.preventDefault();
e.stopPropagation();
return false;
});
});

function isCloseEnoughForPouring(){
if(!tubeAElement||!tubeBElement) return false;
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);
return distance >= 1.0 && distance <= 1.5;
}

function isCloseEnoughForReaction(){
if(!tubeAElement||!tubeBElement) return false;
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);
return distance >= 1.0 && distance <= 1.5 && pouredAmount >= MAX_POUR * 0.7;
}

function startPouring(){
if(pourInterval) return;
pourInterval = setInterval(() => {
if(pouredAmount < MAX_POUR){
const pourRate = Math.abs(pourAngle) / 90 * 0.005;
liquidLevelA = Math.max(0.1, liquidLevelA - pourRate);
liquidLevelB = Math.min(0.55, liquidLevelB + pourRate);
pouredAmount += pourRate;
updateLiquidLevels();
createPouringDrop();
}
}, 50);
}

function stopPouring(){
if(pourInterval){
clearInterval(pourInterval);
pourInterval = null;
}
}

function createPouringDrop(){
if(!tubeAElement || !tubeBElement) return;

const drop=document.createElement('a-sphere');
drop.setAttribute('radius','0.015');
drop.setAttribute('color',BLUE_COLOR);
drop.setAttribute('opacity','0.9');

// Calculate drop start position (from tilted tube opening)
const tiltRad = pourAngle * Math.PI / 180;
const tubeHeight = 0.6;
const startX = tubeAElement.object3D.position.x;
const startY = tubeAElement.object3D.position.y + 0.3 - Math.sin(tiltRad) * 0.25;
const startZ = tubeAElement.object3D.position.z + Math.cos(tiltRad) * 0.25;

drop.setAttribute('position',{
x:startX,
y:startY,
z:startZ
});

// Target position (yellow tube opening)
const targetX = tubeBElement.object3D.position.x;
const targetY = tubeBElement.object3D.position.y + 0.45;
const targetZ = tubeBElement.object3D.position.z;

// Parabolic animation for realistic pour
drop.setAttribute('animation',{
property:'position',
from:`${startX} ${startY} ${startZ}`,
to:`${targetX} ${targetY} ${targetZ}`,
dur:800,
easing:'easeInQuad'
});

drop.setAttribute('animation__scale',{
property:'scale',
from:'1 1 1',
to:'0.5 0.5 0.5',
dur:800
});

drop.setAttribute('animation__opacity',{
property:'opacity',
from:'0.9',
to:'0',
dur:800
});

document.querySelector('a-scene').appendChild(drop);

// Remove drop after animation
setTimeout(()=>{
if(drop.parentNode){
drop.parentNode.removeChild(drop);
}
},800);
}

function checkDistanceForReaction(){
if(!tubeAElement||!tubeBElement) return;
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);

// Calculate mixing based on poured amount
const mixAmount = Math.min(1.0, pouredAmount / MAX_POUR);

if(distance >= 1.0 && distance <= 1.5){
if(isPouringActive){
mixLiquids(mixAmount);
document.getElementById('status').textContent=`Pouring... ${Math.round(mixAmount*100)}% mixed`;
document.getElementById('status').style.color=BLUE_COLOR;
updateInstruction("Keep pouring to complete the reaction");
}else if(pouredAmount > 0){
mixLiquids(mixAmount);
document.getElementById('status').textContent=`Ready - ${Math.round(mixAmount*100)}% mixed`;
document.getElementById('status').style.color="#ff9900";
updateInstruction("Drag up to pour more liquid");
}else{
mixLiquids(0);
document.getElementById('status').textContent="Ready - Tilt to pour";
document.getElementById('status').style.color=GREEN_COLOR;
updateInstruction("Drag up to tilt and pour liquid");
}
}else if(distance < 1.0){
mixLiquids(0);
document.getElementById('status').textContent="Too close! Move slightly away";
document.getElementById('status').style.color="#ff4444";
updateInstruction("Move blue tube slightly away");
}else{
mixLiquids(0);
document.getElementById('status').textContent="Too far - get closer";
document.getElementById('status').style.color="#ffffff";
updateInstruction("Drag blue tube closer to yellow tube");
}
}

function updateLiquidLevels(){
// Update blue liquid
const newHeightA = liquidLevelA * 0.45;
const newPositionA = 0.15 + (newHeightA/2);
const liquidA = document.querySelector('#liquidA');
const surfaceA = document.querySelector('#surfaceA');
if(liquidA && surfaceA){
liquidA.setAttribute('height', newHeightA);
liquidA.setAttribute('position', `0 ${newPositionA} 0`);
surfaceA.setAttribute('position', `0 ${0.15 + newHeightA} 0`);
}

// Update yellow liquid
const newHeightB = liquidLevelB * 0.45;
const newPositionB = 0.15 + (newHeightB/2);
const liquidB = document.querySelector('#liquidB');
const surfaceB = document.querySelector('#surfaceB');
if(liquidB && surfaceB){
liquidB.setAttribute('height', newHeightB);
liquidB.setAttribute('position', `0 ${newPositionB} 0`);
surfaceB.setAttribute('position', `0 ${0.15 + newHeightB} 0`);
}
}

function mixLiquids(mixAmount){
if(mixAmount<=0){
// No mixing - original colors
document.querySelector('#liquidA').setAttribute('color',BLUE_COLOR);
document.querySelector('#surfaceA').setAttribute('color',BLUE_COLOR);
document.querySelector('#liquidB').setAttribute('color',YELLOW_COLOR);
document.querySelector('#surfaceB').setAttribute('color',YELLOW_COLOR);
}else if(mixAmount>=1.0){
// Full mixing - green
document.querySelector('#liquidA').setAttribute('color',GREEN_COLOR);
document.querySelector('#surfaceA').setAttribute('color',GREEN_COLOR);
document.querySelector('#liquidB').setAttribute('color',GREEN_COLOR);
document.querySelector('#surfaceB').setAttribute('color',GREEN_COLOR);
}else{
// Partial mixing - calculate intermediate color
const blueR=parseInt(BLUE_COLOR.substr(1,2),16);
const blueG=parseInt(BLUE_COLOR.substr(3,2),16);
const blueB=parseInt(BLUE_COLOR.substr(5,2),16);
const yellowR=parseInt(YELLOW_COLOR.substr(1,2),16);
const yellowG=parseInt(YELLOW_COLOR.substr(3,2),16);
const yellowB=parseInt(YELLOW_COLOR.substr(5,2),16);
const mixedR=Math.round(blueR+(yellowR-blueR)*mixAmount);
const mixedG=Math.round(blueG+(yellowG-blueG)*mixAmount);
const mixedB=Math.round(blueB+(yellowB-blueB)*mixAmount);
const mixedColor='#'+
mixedR.toString(16).padStart(2,'0')+
mixedG.toString(16).padStart(2,'0')+
mixedB.toString(16).padStart(2,'0');
document.querySelector('#liquidA').setAttribute('color',mixedColor);
document.querySelector('#surfaceA').setAttribute('color',mixedColor);
document.querySelector('#liquidB').setAttribute('color',mixedColor);
document.querySelector('#surfaceB').setAttribute('color',mixedColor);
}
}

function updatePositionInfo(){
if(tubeAElement&&tubeBElement){
const posA=tubeAElement.object3D.position;
const posB=tubeBElement.object3D.position;
const distance=Math.sqrt(
Math.pow(posA.x-posB.x,2)+
Math.pow(posA.z-posB.z,2)
);
document.getElementById('position-info').innerHTML=
'Distance: '+distance.toFixed(1)+'<br>'+
'Tilt: '+Math.abs(pourAngle).toFixed(1)+'Â°<br>'+
'Poured: '+Math.round(pouredAmount/MAX_POUR*100)+'%';
}
}

function updateInstruction(message){
const instruction=document.querySelector('.instruction');
if(instruction){
instruction.textContent=message;
}
}

function updateStatus(){
if(tubeAVisible&&tubeBVisible){
if(reactionStarted){
document.getElementById('status').textContent="Reaction Complete!";
updateInstruction("Reaction successful! Press Reset to try again");
}else{
document.getElementById('status').textContent="Ready - Drag blue tube";
}
}else if(tubeAVisible){
document.getElementById('status').textContent="Blue tube found";
updateInstruction("Scan yellow tube marker");
}else if(tubeBVisible){
document.getElementById('status').textContent="Yellow tube found";
updateInstruction("Scan blue tube marker");
}else{
document.getElementById('status').textContent="Scan both markers";
updateInstruction("Scan both tube markers");
}
}

function completeReaction(){
reactionStarted=true;
stopPouring();
// Final green color
mixLiquids(1.0);
document.getElementById('status').textContent="Reaction Complete!";
document.getElementById('status').style.color=GREEN_COLOR;

// Create celebration effects
for(let i=0;i<20;i++){
setTimeout(()=>{
const bubble=document.createElement('a-sphere');
bubble.setAttribute('radius','0.025');
bubble.setAttribute('color',GREEN_COLOR);
bubble.setAttribute('opacity','0.8');
if(tubeBElement){
const pos=tubeBElement.object3D.position;
bubble.setAttribute('position',{
x:pos.x+(Math.random()-0.5)*0.1,
y:pos.y+0.2,
z:pos.z+(Math.random()-0.5)*0.1
});
}
bubble.setAttribute('animation',{
property:'position',
to:`${tubeBElement.object3D.position.x+(Math.random()-0.5)*0.2} ${tubeBElement.object3D.position.y+0.8} ${tubeBElement.object3D.position.z+(Math.random()-0.5)*0.2}`,
dur:1200,
easing:'easeOutQuad'
});
bubble.setAttribute('animation__opacity',{
property:'opacity',
to:'0',
dur:1200
});
document.querySelector('a-scene').appendChild(bubble);
setTimeout(()=>{
if(bubble.parentNode){
bubble.parentNode.removeChild(bubble);
}
},1200);
},i*100);
}
}

function resetExperiment(){
reactionStarted=false;
isDragging=false;
isPouringActive=false;
pourAngle=0;
pouredAmount=0;
stopPouring();

if(tubeAElement){
tubeAElement.object3D.position.set(0,0,0);
tubeAElement.setAttribute('rotation','0 0 0');
tubeStartPos={x:0,y:0,z:0};
}

// Reset liquid levels
liquidLevelA=0.45;
liquidLevelB=0.45;
updateLiquidLevels();

mixLiquids(0); // Reset to original colors

document.getElementById('status').textContent="Scan both markers";
document.getElementById('status').style.color="white";

updateStatus();
updatePositionInfo();
updateInstruction("Scan both tube markers");
}
</script>
</head>

<body>

<div id="hud">
<h3>ðŸ§ª Chemical Mixing</h3>
<p id="status">Scan both markers</p>
<button onclick="resetExperiment()">Reset</button>
</div>

<div class="position-info" id="position-info">
Position: --<br>Distance: --
</div>

<div class="instruction">
Scan both tube markers
</div>

<a-scene embedded arjs="debugUIEnabled:false;">

<a-light type="ambient" intensity="0.8"></a-light>
<a-light type="directional" position="1 2 1" intensity="0.6"></a-light>

<a-marker id="markerA" type="pattern" url="markers/testtube_markerA.patt">
<a-entity id="tubeA">
<a-cylinder radius="0.15" height="0.6" position="0 0.3 0" color="#ffffff" opacity="0.55" roughness="0.2" metalness="0.4" transparent="true"></a-cylinder>
<a-cylinder id="liquidA" radius="0.13" height="0.45" position="0 0.225 0" color="#0088ff" opacity="0.95"></a-cylinder>
<a-circle id="surfaceA" radius="0.13" position="0 0.45 0" color="#0088ff" rotation="-90 0 0"></a-circle>
</a-entity>
</a-marker>

<a-marker id="markerB" type="pattern" url="markers/testtube_markerB.patt">
<a-entity id="tubeB">
<a-cylinder radius="0.15" height="0.6" position="0 0.3 0" color="#ffffff" opacity="0.55" roughness="0.2" metalness="0.4" transparent="true"></a-cylinder>
<a-cylinder id="liquidB" radius="0.13" height="0.45" position="0 0.225 0" color="#ffff00" opacity="0.95"></a-cylinder>
<a-circle id="surfaceB" radius="0.13" position="0 0.45 0" color="#ffff00" rotation="-90 0 0"></a-circle>
</a-entity>
</a-marker>

<a-entity camera></a-entity>

</a-scene>

</body>
</html>
